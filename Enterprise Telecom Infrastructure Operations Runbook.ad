= telcoItaly FastDelivery's Documentation: Day to day activities
FB <fabiana.coworker@consulences.com>; GS <gabriele.saronni@consulences.com>
1.8.6, 19/03/2025
:title-page:
:toc: 
:sectnums:
:toclevels: 2
:toc-title: telcoItaly FastDelivery Activities
:icons: font

<<<

.Revision history
[cols="10h,12h,10h,~"]
|===
|Version |Date |Authors |Description

|1.8 |13/05/2024 |{author_2} |Merged Fastdelivery's wiki
|1.8.1 |23/05/2024 |{author} |Restore All Services On Servers
|1.8.1.1 |11/07/2024 |{author_2} |Added software versions
|1.8.1.2 |12/12/2024 |{author_2} |Updated Disk Space table references
.3+.^|1.8.2 .3+.^|16/12/2024 .3+.^|{author_2} d|Added Decommissioning steps d|Moved CM under ASA d|Updated Project Owners table
|1.8.3 |27/01/2025 |{author_2} |Expanded decommission, added Assyst contact, refined osq282v cert
|1.8.3.1 |30/01/2025 |{author_2} |Finally found how report.apptitcare works
|1.8.3.2 |03/02/2025 |{author_2} |pfx extraction of pem and key file
|1.8.4 |25/02/2025 |{author} |certificate error fix 
|1.8.5 |25/02/2025 |{author} | DNS decommision on telcoItaly.it
|1.8.6 |19/03/2025 |{author_2} |SunOS commands reference
|1.8.7 |26/06/2025 |{author_2} |Updated certificates link
|===

<<<

== Network Device Table

.Partial Device Table
|===
|Hostname |IP |Management IP |Description 

|MI-TSR90 |10.133.121.131 |10.128.127.44 |Terminal Server

|MI-VFX900 chassis |10.133.121.133 | |Firewall DC F&D - active
|MI-VFX901 chassis |10.133.121.134 | |Firewall DC F&D - standbyF
|MI-VFX900 |10.133.121.141 | .2+.^|ASA FirePower
|MI-VFX901 |10.133.121.142 | 
|MI-VFX900 MGMT | |10.128.127.36 .8+.^|ASA Firepower Contextes
|MI-VFX901 MGMT | |10.128.127.37 
|MI-VFX900 DMZ | |10.128.127.38 
|MI-VFX901 DMZ | |10.128.127.39 
|MI-VFX900 BACKEND | |10.128.127.40 
|MI-VFX901 BACKEND | |10.128.127.41 
|MI-VFX900 FRONTEND | |10.128.127.42 
|MI-VFX901 FRONTEND | |10.128.127.43 

|MI-VMX900 |10.133.121.135 |10.128.127.49 .4+.^|Router DC F&D 
|MI-VMX901 |10.133.121.136 |10.128.127.50 
|MI-VMX904 |10.133.121.139 |10.128.127.51 
|MI-VMX905 |10.133.121.140 |10.128.127.52 

|MI-VSX906 | |10.128.126.135 .2+.^|Hardware ISE 
|MI-VSX907 | |10.128.126.136 
|MI-VSX909 | |10.128.123.7 .2+.^|ISE Application 
|MI-VSX910 | |10.128.123.8 

|MIVLB513 | |10.128.126.165 |F5 Pre bilanciatore standalone
|MIVLB514 | |10.128.126.175 |F5 Pro bilanciatore standby
|MIVLB515 | |10.128.126.176 |F5 Pro bilanciatore active
|miobmplbs1 | |10.133.225.126 |Virtualized F5 Pro bilanciatore active 
|miobmplbs2 | |10.133.225.127 |Virtualized F5 Pro bilanciatore standby

|osx100v| |10.129.166.100 |Proxy Active
|osx222v | |10.129.166.102 |Proxy Standby 

|VIP for system admin | |10.129.166.101:8080 |Proxy VIP 

|mi5fdsx008 | |10.128.123.5 |DNS master 
|osx101v | |10.129.166.21 .2+.^|DNS public/external
|osx102v | |10.129.166.22
|osx103v | |10.129.169.21 .2+.^|DNS private/internal
|osx104v | |10.129.169.22 

|osx215v | |10.129.164.114 |Certificates dump

|mi5fdsx001 | |10.128.123.78 |Backup server

|===

<<<

== ASA Firepower Firewall

.Cisco ASA
|===
|DNS       |IP             |Model          |ASA Version |FXOS Version | Description

|MI-VFX900 |10.133.121.133 .2+.^|Firepower 4110 .2+.^|9.18.4.29 .2+.^|2.12(1.172)   |Active
|MI-VFX901 |10.133.121.134    |Passive

|===

.Support
https://cloudsso.cisco.com/as/authorization.oauth2?response_type=code&code_challenge=EBnfxv1KbFmuY7Uc3QgLIy-S9wQkmP9Zxz_EkasHxLo&code_challenge_method=S256&client_id=wam_prod_ac&redirect_uri=https%3A%2F%2Fmycase.cloudapps.cisco.com%2Fpa%2Foidc%2Fcb&state=eyJ6aXAiOiJERUYiLCJhbGciOiJkaXIiLCJlbmMiOiJBMTI4Q0JDLUhTMjU2Iiwia2lkIjoiLVZpaVlVZWI4a1lOem9DM1RLYWpEY1BFaldRIiwic3VmZml4IjoiZThManVELjE2NjgxNjI4NDUifQ..IjwxXbhS1AcJ2l6yelJwcg.yzfm2e-35jcVoAYA6An1F20wyMKdCoQ9VrK_eq-YWlcxMKUn3Cqb73SAmINo1bYOJab05kvq8Q9o2WjnVgnCV_N9qMh2ppuAd_rdtE2BvEoMwaQWlv4rC5jf2ESbmuEMOcpZnSrlD33gLfCw6naqPugIWZBLM89ivMLIuyw6sek.5Z-7LTkFjs3stKT-SlkHsg&nonce=pxSd7BFMjaL6SwvE2s8jXxCLNf2K-zwAVNvek2R6e4s&acr_values=stdnomfa&scope=openid%20profile%20address%20email%20phone&vnd_pi_requested_resource=https%3A%2F%2Fmycase.cloudapps.cisco.com%2Fcase&vnd_pi_application_name=CAEAXprod-mycase.cloudapps[Cisco Case] +
https://www.cisco.com/c/en/us/td/docs/security/firepower/fxos/compatibility/fxos-compatibility.html[Cisco compatibility matrix]

=== Configuring ACL

* This can be done with the private IP or a network plus the subnet mask  
* To get the Private IP from powershell do: `nslookup <PublicIPaddress>` 
* Check from where that IP will arrive:
** From the correct MI-VFX900-1 context run: `show route <IPaddress>`

.Example:
```Cisco
MIVFX900-1/BACKEND/pri/act# show route 198.19.32.144
Routing Table: BACKEND
Routing entry for 198.19.32.0 255.255.254.0, supernet
Known via "static", distance 1, metric 0
Routing Descriptor Blocks:
-192.168.25.1, via ITDCC
Route metric is 0, traffic share count is 1
```

NOTE: This specific example was done from BACKEND context because the VFR (Virtual routing and forwarding) routes through that context

==== To Add an IP
> Also called "an opening" or "un'apertura"

* Log into MI-VFX900-1
* Check the IP source to know which context will be
* Run the following:

```Cisco
change context <contextName>
configuration terminal
access-list GLOBAL_ACL extended permit <protocol> host <sourceIP> host <destinationIP> eq <port>  
access-list GLOBAL_ACL extended permit tcp host X.X.X.X host X.X.X.X eq https  
write
```

WARNING: Has to be repeated in needed contexts

==== To Add Using a Network
* When the mask is provided run: 
** `access-list GLOBAL_ACL extended permit tcp 10.106.116.0 255.255.252.0 host 10.129.171.43 eq 443`  
** `access-list GLOBAL_ACL extended permit <protocol> <sourceIP> <sourceMask> host <destinationIP> eq <port>`

==== To Delete an ACL
* Search for the ACL you need to erase using: `show access-list | include x.x.x.x`
* Put `no` in front of the line. 
** Example: `no access-list GLOBAL_ACL extended permit tcp 10.106.116.0 255.255.252.0 host 10.129.171.43 eq 443`

.In Case of Errors check:
* the contexts routing table 
* the Network Scheme
* if all the involving teams where contacted, such as Montesano

==== ACL using object-group
* There are some cases where you will add the source IP to an `object-group` that compress all the destination IPs. 
** Example: `access-list GLOBAL_ACL extended permit tcp host 10.132.181.117 `object-group objN-MgmT-Net eq 22`  
** In this case we have a server that wants to reach an IP inside MGMT context where there is an `object-group` containing all the IPs `object-group network objN-MgmT-Net`
* To search an `object-group` run `show object-group | include <keyWordOrIp>` from the needed context, then use the `<line number>` to find the object-group.

IMPORTANT: Remember to search in all contextes.

==== Access Control List Additional Info
NOTE: You can find additional informations https://www.Cisco.com/c/en/us/td/docs/security/asa/asa96/configuration/firewall/asa-96-firewall-config/access-acls.html#ID-2069-0000011a[here]

* An e-mail request will start the procedure
* If the `object-group` is not mentioned it has to be retrieved
** From `10.128.123.78 2022/MI-VFX900` most recent backup run `grep <ipAddress/KeyWord> 2022/MI-VFX900/<mostRecent>`
** From `10.128.123.78 2022/MI-VFX900` most recent backup open it with mobaXterm or download it and with `ctrl+f <ipAddress/KeyWord>`
* Configure the ACL inside the DMZ context like explained above with correct `object-group`, in the example is objN-VPN-Reply and the correspondent IP
** Example: `access-list GLOBAL_ACL extended permit tcp `object-group` *objN-VPN-Reply* host x.x.x.x eq https`

TIP: In case you need to find the Private IP or just want to corroborate info run from powershell while in VPN telcoItaly and logged-in ASA `nslookup <FQDN>` (Fully Qualified Domain Name)

CAUTION: The inverted flux is not permitted: `access-list GLOBAL_ACL line 5493 extended permit tcp host 10.129.170.39 `object-group` objN-VPN-Reply eq https (hitcnt=0) 0x4b4e153c`

=== Block IP from Firewall
. Connect to MIVFX900 firewall via `ssh 10.133.121.141`
. Change context to DMZ: `MIVFX900-1/MGMT/sec/act# changeto context DMZ`
. Create group with the objects that needs to be blocked:

```Cisco
MIVFX900-1/DMZ/sec/act# configuration terminal
MIVFX900-1/DMZ/sec/act(config)# object-group network CNG_DD_MM_YYYY
MIVFX900-1/DMZ/sec/act(config-network-object-group)# network-object host x.x.x.x
MIVFX900-1/DMZ/sec/act(config-network-object-group)# network-object host y.y.y.y
MIVFX900-1/DMZ/sec/act(config-network-object-group)# exit
```

[start=4]
. Select macro-group IP_DENY_container: (config-network-object-group)
* `object-group network IP_DENY_container`
. Add the blocked IP group to the macro-group: (config-network-object-group)
* `group-object CNG_DD_MM_YYYY`
. Verify: 
* Check if IPs are added correctly to the object-group: `show object-group id CNG_05_04_2022`
* Check if the object-group is in the IP_DENY_container: 
** `show object-group id IP_DENY_container | i CNG_DD_MM_YYYY`
. Save the configuration: `write memory`

.Example
```Cisco
MIVFX900-1/DMZ/sec/act(config)# object-group network CNG_04_03_2021
MIVFX900-1/DMZ/sec/act(config-network-object-group)# network-object host 103.77.192.219
network-object host 5.254.43.18
network-object host 80.92.205.81
network-object host 86.105.18.116
network-object host 165.232.154.116
MIVFX900-1/DMZ/sec/act(config-network-object-group)# exit
MIVFX900-1/DMZ/sec/act(config)# object-group network IP_DENY_container
MIVFX900-1/DMZ/sec/act(config-network-object-group)# group-object CNG_04_03_2021
MIVFX900-1/DMZ/sec/act(config-network-object-group)# exit
MIVFX900-1/DMZ/sec/act(config)# show object-group id IP_DENY_container | i CNG_04_03_2021
object-group network IP_DENY_container
 group-object CNG_04_03_2021
```

=== Communication Matrix (CM)

[cols="25%,60%"]
.IP owning table
|===
|Context |IP class

.2+.^|DMZ 
m|10.128.0.0 255.255.0.0
m|10.129.0.0 255.255.0.0



|===

[cols="25%,60%"]
.VRF table
|===
|Context |Virtual Routing Forwarding

|ASA Firepower |DSL_DATA

.2+.^|Frontend 
|UNTRUSTED_U2S 
|SERVICE_CTP

.4+.^|Backend 
|EITO_PROD 
|IT_CSP_TRANSIT 
|TRUSTED_S2S 
|ITDCC

|===

> Image example needed

. what lines are mine? Are always the last ones highlighted?
==== Is it from the inside or the outside?

. If the VRF is given: Check the VRF table
.. If it's not given, start from Backend: `show route <destinationIP>`

```
MIVFX900-1/BACKEND/sec/act# sh route 104.242.226.240

Routing Table: BACKEND
Routing entry for 104.242.226.240 255.255.255.240
  Known via "static", distance 1, metric 0
  Routing Descriptor Blocks:
  * 192.168.28.1, via IT_CSP_TRANSIT
      Route metric is 0, traffic share count is 1
```

. what questions do I need?
. Log into ASR 
.. Look for the prefix set: `show rpl prefix-set <VRF_NAME>`
. Log into Nexus 5k
.. Look for the prefix set: `show vrf <VRF_NAME>`

=== Essentials Firewall Actions 
.Verify the Connection
* Type: `show connection all | i <target IP>`
* Verify Inbound connection flag

.To Recover the VIP
* From powershell run `nslookup <FQDN>` Ex: `nslookup it.infobyip.com`
* Log into MI-VFX900-1 and from DMZ context run `show nat | i <publicIP>` to fetch the private IP used by F5

.Access Chassis from CLI to check physical interfaces
* Connect through SSH to the IP `10.133.121.133/4` or using the Chassis session from MobaXterm access to the ASA Chassis
* Once inside run the following commands:
** `connect fxos` && `sh int e1/5` (or any desired interface)

.Test Connectivity of ACL implementated

* Inside ASA from the needed context launch the command `ping` and enter
* From the choices type `y`to proceed
* Insert the target IP
* Insert destination port
* The option will appear Specify source type `y`to proceed
* Insert the source IP then press enter 3 times to proceed with the test 

```Cisco
MIVFX900-1/DMZ/pri/act# ping
TCP Ping [n]: y
Interface: DMZ-FRONT
Target IP address: 10.129.170.30
Destination port: [80] 22
Specify source? [n]: y
Source IP address: 10.132.18.24
Source port: [0]
Repeat count: [5]
Timeout in seconds: [2]
Type escape sequence to abort.
Warning! Specified source interface DMZ-FRONT is different
than expected source interface LEGACY-PRE!
Sending 5 TCP SYN requests to 10.129.170.30 port 22
from 10.132.18.24, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 1/1/1 ms
```
* For the `packet-tracer` command
** Type input, insert the interface, the protocol, then the IP source, select the port number or protocol, Enter the destination address, and select the port number or protocol. as the example below:

```Cisco
MIVFX900-1/DMZ/pri/act# packet-tracer input DMZ-FRONT tcp 10.132.18.24 1234 10.129.170.30 22 detailed
Result:
input-interface: DMZ-FRONT
input-status: up
input-line-status: up
```

=== Firewall capture
WARNING: Mind disk space, when using `capture`, with `max buffer`

. Connect to the firewall `MIVFX900-1 10.133.121.141`
. Switch to needed context Ex: `MIVFX900-1/MGMT/sec/act# changeto context DMZ`
. Run: `capture <name> type raw-data {trace buffer | circular-buffer} interface <int> match <protocol> <sourceIP> <destinationIP> <port>`

.Example output
```Cisco
capture ADE type raw-data interface APPLICATION-BACK circular-buffer [Capturing * 524259 bytes]
match tcp host 10.129.174.17 any4 eq 27017
```

TIP: For more info on Using Packet Capture to troubleshoot: https://community.Cisco.com/t5/security-documents/asa-using-packet-capture-to-troubleshoot-asa-firewall/ta-p/3129889[MI-VFX900-1 Firewall]

=== NAT in ASA FirePower

TIP: For any doubts consult https://www.practicalnetworking.net/stand-alone/cisco-asa-nat/#autonat[NAT Configuration Guide]

==== AUTO NAT
* Create an `object network` for a private IP inside a NAT
* Check from which interface comes the IP `show route X.X.X.X`
* From `Configuration terminal` run:
* Create the object network as shown in the example below: 

.Example: from `10.129.171.76` map a `91.80.46.115`
```
conf t 
object network obj-10.129.171.76 
host 10.129.171.76
```
* Then configure the nat inside the object network 
```
nat (LEGACY-PRE,DSL_DATA) static 91.80.46.115 no-proxy-arp
```

IMPORTANT: Remember to check and update the IP table and CM if it's available

==== Type 2 NAT

.Create an `object-network` for a private IP inside a NAT
```Cisco
configuration terminal 
MIVFX900-1/DMZ/pri/act(config)# object network host-10.128.128.9
MIVFX900-1/DMZ/pri/act(config-network-object)# host 10.128.128.3
exit
```

.Localize the VRF of origin and destination
```
MIVFX900-1/DMZ/pri/act(config)# nat (internal interface, external interface) source static host-37.25.228.243 host-37.25.228.243 destination static host-83.224.74.49 host-10.128.128.9
```

.Define a specific NAT rule for translating source and destination IP addresses
```
nat (internal interface, external interface) source static host-37.25.228.243 host-37.25.228.243 destination static host-83.224.74.49 host-10.128.128.9
```

In summary, the command configures a NAT rule that keeps the source IP address unchanged (37.25.228.243) for outbound traffic from the "internal interface." + 
For inbound traffic through the "external interface," it translates the destination IP address 83.224.74.49 to 10.128.128.9.

==== Delete an existing NAT

* Select the needed network object:
** MIVFX900-1/DMZ/pri/act(config)# object network obj-10.129.171.153
* Inside `conf t` run one of this 3 examples: 
```
MIVFX900-1/DMZ/pri/act(config)# no object network obj-<Private IP>
MIVFX900-1/DMZ/pri/act(config)# no nat static <Public IP>
MIVFX900-1/DMZ/pri/act(config)# no nat (LEGACY*PRE,DSL_DATA) static <Public IP> no-proxy-arp(optional)
```
=== Failover

NOTE: Right now primary is in standby

|===
|IPS Primary |IPS Secondary

|MIVIX505 |MIVIX503
|IT4SECFPRFTD01 |IT4SECSOU3D01
m|MIVFX900-1/sec/act# m|MIVFX900-1/pri/stby#
|===

. Connect to the devices shown above
. Change context to System: `change context system`
. Verify: `show failover state`
. From the standby run: `failover active`
. Wait to reconnect and run `show failover state`

=== Adding Routes on the ASA

* To add a Route in the Firewall use the following command `route if_name dest_ip mask gateway_ip [ distance ]`
** Example: `route ITDCC 198.19.148.192 255.255.255.224 192.168.25.1 1`
* Sometimes you will need to add the route from the Backend context up to DMZ. The following example shows the established routes coming from the ITDCC VRF in order:

```
From VRF to Backend
route ITDCC X.X.X.X (destination IP) Y.Y.Y.Y (subnet mask) 192.168.25.1 1
From Frontend to Backend -> This is established in the FE context
route FRONT-BACK X.X.X.X (destination IP) Y.Y.Y.Y (subnet mask) 192.168.65.3 1
From Frontend to DMZ -> This is configured in the DMZ context
route DMZ-FRONT X.X.X.X (destination IP) Y.Y.Y.Y (subnet mask)  192.168.64.3 1
```

NOTE: The VRF can vary according to what is indicated in the mail/request or the routing in the ASR 9000

=== Change logging server

IMPORTANT: This has to be done in all contexts, beware of the specific interface for each context

* Search for the needed interface where the configuration is stablished 
* Add the route using the command known
* Go inside the Configuration Terminal, and then direct yourself into the interface
* Once in there use the command: `logging host interfaceName Destination IP protocol/port` 

.Example:
```
MIVFX900-1/MGMT/sec/act# route FDmgmt-MGMT 10.133.213.22 255.255.255.255 10.128.127.33 1
MIVFX900-1/MGMT/sec/act# conf t
MIVFX900-1/MGMT/sec/act(config)# interface Port-channel1.2600
MIVFX900-1/MGMT/sec/act(config-if)#
logging host FDmgmt-MGMT 10.133.213.22 17/12514
wr
```

<<<

== ASR 9001

.Cisco ASA
|===
|DNS |IP |Device |IOS XR |ROM

|MI-VMX900 |10.133.121.135 .2+.^|Cisco ASR 9001 .2+.^|6.4.2 .2+.^|3.04
|MI-VMX901 |10.133.121.136 

|===

.Support
https://cloudsso.cisco.com/as/authorization.oauth2?response_type=code&code_challenge=EBnfxv1KbFmuY7Uc3QgLIy-S9wQkmP9Zxz_EkasHxLo&code_challenge_method=S256&client_id=wam_prod_ac&redirect_uri=https%3A%2F%2Fmycase.cloudapps.cisco.com%2Fpa%2Foidc%2Fcb&state=eyJ6aXAiOiJERUYiLCJhbGciOiJkaXIiLCJlbmMiOiJBMTI4Q0JDLUhTMjU2Iiwia2lkIjoiLVZpaVlVZWI4a1lOem9DM1RLYWpEY1BFaldRIiwic3VmZml4IjoiZThManVELjE2NjgxNjI4NDUifQ..IjwxXbhS1AcJ2l6yelJwcg.yzfm2e-35jcVoAYA6An1F20wyMKdCoQ9VrK_eq-YWlcxMKUn3Cqb73SAmINo1bYOJab05kvq8Q9o2WjnVgnCV_N9qMh2ppuAd_rdtE2BvEoMwaQWlv4rC5jf2ESbmuEMOcpZnSrlD33gLfCw6naqPugIWZBLM89ivMLIuyw6sek.5Z-7LTkFjs3stKT-SlkHsg&nonce=pxSd7BFMjaL6SwvE2s8jXxCLNf2K-zwAVNvek2R6e4s&acr_values=stdnomfa&scope=openid%20profile%20address%20email%20phone&vnd_pi_requested_resource=https%3A%2F%2Fmycase.cloudapps.cisco.com%2Fcase&vnd_pi_application_name=CAEAXprod-mycase.cloudapps[Cisco Case]

=== Add route to existing prefix
Verify the configuration of the VRF: `show run vrf UNTRUSTED_U2S`

.To configure the VRF
```
configuration terminal
vrf context UNTRUSTED_U2S
ip route X.X.X.X/X Vlan<id> IP next-hop address in format i.i.i.i
```

NOTE: You don't need to go into 'conf t' to add or remove the routes

[cols="15%,90%"]
|===
|prefix  |cmd

|see     |`show rpl prefix-set`
|add     |`edit prefix-set pfx_ITDCC_fromPE inline add "198.19.145.32/27 le 32"`
|remove  |`edit prefix-set pfx_ITDCC_fromPE inline remove "198.19.145.32/27 le 32"`
|===

> When PE is source: From PE // +
> When PE is destination: To PE

===  Verifying the subnet of the network to add in the prefix
* Insert the IP in the following https://ccp.telcoItaly.com/find/network[Tool]
* The result will indicate both the network and the subnet. 
* If subnet on CCP tool is marked with:

```
GDC Dedicated VF-Italy is equal to ITDCC
GDC Internal Shared - VOD is equal to EITOPROD
```

=== Verifying Reachability

.Use the following commands to verify routing exchange and reachability informations in Border Gateway Protocol (BGP)
|===
|Input Command                                            |Command Description

|show route                                               |Shows information about the routing table 
|sh bgp all unicast                                       |Displays information about the BGP routing table entry
|show bgp ipv4 unicast 10.133.227.6                       |Displays information about the BGP routing table entry for the specific IP address
|show bgp vrf ITDCC neighbors                             |Displays information about BGP neighbors within a specific VRF
|show bgp vrf ITDCC neighbors 10.177.37.1 received routes |Displays configuration information and statistics for BGP4 neighbors of the device for a virtual routing and forwarding (VRF) instance
|sh bgp route + rpl_CE-PE_vrf-XXXX-IN/OUT                 |Displays information about  the current BGP routing state and the paths available for routing traffic through the network
|===

NOTE: Additional Info regarding https://docs.ruckuswireless.com/fastiron/08.0.50/fastiron*08050*commandref/GUID*B1F2522E*8575*47C6*9591*8D6966165ED9.html[BGP VRF]

=== Useful Commands 

|===
|Input Command                                     |Command Description

|`show tech-support bcdl`                            |Displays technical support information for the BCDL module.
|`show bdcl consumers`                               |Shows information about BDCL (Block Distributed Control Loop) consumers.
|`show process blocked location all`                 |Shows all blocked processes and their locations.
|`show bdf session`                                  |Displays information about the BDF (Binary Data Format) sessions.
|`show bdf session detail`                           |Shows detailed information about the BDF (Binary Data Format) sessions.
|`show bgp nei 3.3.3.2`                              |Displays BGP (Border Gateway Protocol) neighbors for the specified IP.
|`show bgp vrf <name> nei 3.12.1.2`                  |Displays BGP neighbors for the specified VRF (Virtual Routing and Forwarding).
|`show route bgp`                                    |Shows BGP (Border Gateway Protocol) routes.
|`bgp auto-policy-soft-reset disable`                |Disables automatic soft reset for BGP.
|`no bgp auto-policy-soft-reset disable`             |Enables automatic soft reset for BGP.
|`bgp graceful-restart`                              |Enables graceful restart for BGP.
|`no bgp graceful-restart`                           |Disables graceful restart for BGP.
|`show bgp neighbor 10.0.101.1 config`               |Displays the configuration of the BGP neighbor with the specified IP.
|`show bgp process`                                  |Shows information about the BGP process.
|`clear bgp ipv4 multicast dampening 172.20.0.0/16`  |Clears BGP multicast dampening for the specified IPv4 address range.
|`clear bgp external`                                |Clears external BGP (Border Gateway Protocol) sessions.
|`clear bgp vrf vrf_A nexthop performance stats`     |Clears the performance statistics for the specified VRF nexthop.
|`show bgp vpnv4 unicast vrf`                        |Displays BGP VPNv4 (Virtual Private Network version 4) unicast for the VRF.
|===

<<<

== ISE

.Cisco UCS-ISE
|===
|DNS |IP |Description

|MI-VSX906 |10.128.126.135 .2+.^|Cisco Integrated Management Controller
|MI-VSX907 |10.128.126.136 

|MI-VSX909 |10.128.123.7 |Active node
|MI-VSX910 |10.128.123.8 |Secondary node
|===

.Support
https://cloudsso.cisco.com/as/authorization.oauth2?response_type=code&code_challenge=EBnfxv1KbFmuY7Uc3QgLIy-S9wQkmP9Zxz_EkasHxLo&code_challenge_method=S256&client_id=wam_prod_ac&redirect_uri=https%3A%2F%2Fmycase.cloudapps.cisco.com%2Fpa%2Foidc%2Fcb&state=eyJ6aXAiOiJERUYiLCJhbGciOiJkaXIiLCJlbmMiOiJBMTI4Q0JDLUhTMjU2Iiwia2lkIjoiLVZpaVlVZWI4a1lOem9DM1RLYWpEY1BFaldRIiwic3VmZml4IjoiZThManVELjE2NjgxNjI4NDUifQ..IjwxXbhS1AcJ2l6yelJwcg.yzfm2e-35jcVoAYA6An1F20wyMKdCoQ9VrK_eq-YWlcxMKUn3Cqb73SAmINo1bYOJab05kvq8Q9o2WjnVgnCV_N9qMh2ppuAd_rdtE2BvEoMwaQWlv4rC5jf2ESbmuEMOcpZnSrlD33gLfCw6naqPugIWZBLM89ivMLIuyw6sek.5Z-7LTkFjs3stKT-SlkHsg&nonce=pxSd7BFMjaL6SwvE2s8jXxCLNf2K-zwAVNvek2R6e4s&acr_values=stdnomfa&scope=openid%20profile%20address%20email%20phone&vnd_pi_requested_resource=https%3A%2F%2Fmycase.cloudapps.cisco.com%2Fcase&vnd_pi_application_name=CAEAXprod-mycase.cloudapps[Cisco Case]

=== Password Change and Reset in Cisco ISE

==== Admin Password 

[.lead]
In Cisco ISE the WebGUI and CLI admin username and passwords are separate. + 

In order to change the passwords you can use the following methods:

TIP: When doing the CLI password keep a shell of both nodes `MI-VSX909/10` in order to avoid login issues.

* Run `password`. The CLI password is unique to each ISE node but we usually put the same
* WebGUI password can be changed from CLI with `application reset-passwd ise <username-here>`. 

.Example:
```config
MIVSX909/admin# password
Enter old password:
Enter new password:
% Password must contain at least one digit.
Enter new password:
Confirm new password:
MIVSX909/admin# application rese
reset-config  reset-passwd
MIVSX909/admin# application reset-passwd ise admin
Enter new password:
Confirm new password:


Password reset successfully.

MIVSX909/admin#
```

Reset the password from another account
.Example:
```cfg
MIVSX909/zzsaronnig# conf t
MIVSX909/zzsaronnig(config)# username admin password plain IlEhe;1CiQqIEUqP role admin
```

CAUTION: The WebGUI password must be reset on the Primary PAN, this password is then synchronised to all ISE nodes.

.WebGUI:
* Navigate to `Administration` -> `System` -> `Admin Access` -> `Administrators` -> `Admin Users`

IMPORTANT: Has to be done in **both** Cisco devices

==== ISE GUI Password Recovery Mechanism

. Use the CLI admin account to log in on the console.

NOTE: Remember that the console admin account is different than the web GUI admin account. They have the same username but can have different passwords.

[start=2]
. From the command prompt, use the `application reset-passwd ise admin` command to set a new web GUI admin password.
. Prompt to reset password appears as shown in this image:

image:images/imageISE.png[image,width=279,height=230]

[start=4]
. Enter the new password as required.
. To confirm that the new password works, use the new password to log in to GUI.

==== Personal Account Password zz<youruser>

* Go to ISE `10.128.123.7` log in with the admin credentials in the GUI
* Open `Administration`
* Go to `Identities`
* Search the needed username 
* Click it -> edit -> create the new password

==== Resetting a forgotten ISE Password

If you have forgotten the ISE CLI password you can only reset this by booting from the ISE DVD/ISO

.Select option 3 or 4
image::images/passwordReset.png[image,width=298,height=114]

.Select option [1] Recover Administrator Password
image::images/passwordReset2.png[image,width=198,height=76]

* Select Admin account and enter the new password
* Save changes and exit to reboot the ISE node

=== Configure Repository mi5fdsx001 on ISE 

* Cause: 90gg password expire
* For more information. Refer to https://www.cisco.com/c/en/us/support/docs/security/identity-services-engine-software/215348-how-to-configure-repository-on-identity.html[Cisco Documentation]

WARNING: ISE Alarm: Info: Scheduled report export failed. Unable to copy the exported file to repository.

* Fix: Change mi5fdsx001 password
** Update inventory 
** Update **both** ISE devices. 


```
Connect to repository MI5FDSX001
MIVSX909/admin# configure terminal
MIVSX909/admin(config)# repository MI5FDSX001
  url sftp://10.128.123.78/app/usrbck/iseusrbck
  user fpusrbck password plain <putThePlainPswHere>
```

WARNING: Host key of the server must be added using 'crypto host_key add' exec command before sftp repository can be used.

```
MIVSX909/admin(config-Repository)#exit
MIVSX909/admin# crypto host_key add host MI5FDSX001
host key fingerprint added
Operating in CiscoSSL FIPS mode

# Host MI5FDSX001 found: line 1
MI5FDSX001 RSA SHA256:UMzbvD0MI4GRFaQNvq5X2ZK4H5qjbpt5+rC56aTCXWY
```

* If the alarm keeps arriving check ISE GUI. Go to Administration -> System -> Maintenance -> Repository.
* Select the repository `MI5FDSX001` and click edit. Update the psw.

> _Don't ask me why they do not use ssh key exchange_

=== Make a Bundle in Cisco ISE
* Go to the `10.128.123.7` address log in with the admin credentials:
** Has to be done in **both** nodes
** Choose an encryption key bundle123
** Choose key's longevity
* The saved logs are:
** Debug logs
** Local logs
** Monitoring and reporting logs
** System logs

=== OCSP Certificate Renewal 

* This certificate is autogenerated inside the Cisco ISE `MI-VSX909`, to access the CSR generator follow the steps below:

IMPORTANT: You must request one certificate for each node

* To generate new self-signed certificates, navigate to  Administration > System > Certificates > System Certificates. Click the Generate Self Signed Certificate.

image::images/ospfCert1.png[image,width=596,height=228]

* Under the Usage section, select the role to be used from the drop-down menu. To Renew OCSP Certificate select the corresponding option. 

* ISE itself will autogenerate and update the certificates for both nodes. Last step will be to control everything is up to date.

<<<
  
== Cisco Nexus 5000

.Cisco Nexus 5612
|===
|DNS |IP |Device |BIOS |System

|MI-VMX904 |10.133.121.139 .2+.^|Cisco Nexus 5612 .2+.^|3.7.0 .2+.^|7.3(3)N1(1)
|MI-VMX905 |10.133.121.140 
|===

.Support
https://cloudsso.cisco.com/as/authorization.oauth2?response_type=code&code_challenge=EBnfxv1KbFmuY7Uc3QgLIy-S9wQkmP9Zxz_EkasHxLo&code_challenge_method=S256&client_id=wam_prod_ac&redirect_uri=https%3A%2F%2Fmycase.cloudapps.cisco.com%2Fpa%2Foidc%2Fcb&state=eyJ6aXAiOiJERUYiLCJhbGciOiJkaXIiLCJlbmMiOiJBMTI4Q0JDLUhTMjU2Iiwia2lkIjoiLVZpaVlVZWI4a1lOem9DM1RLYWpEY1BFaldRIiwic3VmZml4IjoiZThManVELjE2NjgxNjI4NDUifQ..IjwxXbhS1AcJ2l6yelJwcg.yzfm2e-35jcVoAYA6An1F20wyMKdCoQ9VrK_eq-YWlcxMKUn3Cqb73SAmINo1bYOJab05kvq8Q9o2WjnVgnCV_N9qMh2ppuAd_rdtE2BvEoMwaQWlv4rC5jf2ESbmuEMOcpZnSrlD33gLfCw6naqPugIWZBLM89ivMLIuyw6sek.5Z-7LTkFjs3stKT-SlkHsg&nonce=pxSd7BFMjaL6SwvE2s8jXxCLNf2K-zwAVNvek2R6e4s&acr_values=stdnomfa&scope=openid%20profile%20address%20email%20phone&vnd_pi_requested_resource=https%3A%2F%2Fmycase.cloudapps.cisco.com%2Fcase&vnd_pi_application_name=CAEAXprod-mycase.cloudapps[Cisco Case]

=== Check the routing 

* Log into the MIVMX904 or MIVMX905. Run `sh ip prefix-list ?` to show existing prefixs. Example:

```Cisco
MIVMX904# sh ip prefix-list ?
  <CR>
  >                      Redirect it to a file
  >>                     Redirect it to a file in append mode
  WORD                   Name of prefix-list (Max Size 63)
  static-DSL_DATA        Known prefix-list name
  static-EITO_PROD       Known prefix-list name
  static-ITDCC           Known prefix-list name
  static-IT_CSP_TRANSIT  Known prefix-list name
  static-MGMT            Known prefix-list name
  static-SERVICE_CTP     Known prefix-list name
  static-TRUSTED_S2S     Known prefix-list name
  static-UNTRUSTED_U2S   Known prefix-list name
  |                      Pipe command output to filter

MIVMX904#sh ip prefix-list static-IT_CSP_TRANSIT
ip prefix-list static-IT_CSP_TRANSIT: 2 entries
   seq 5 permit 10.129.160.0/20
   seq 10 permit 10.128.128.0/22
```
* Has to be picked depending on the VRF
* If the IP is already inside the prefix there's no need to configure the routing, add the ACL to each context 

=== Network insertion on prefix-list 

* To insert a new IP in the prefix-list follow the steps below:
* Go to `configure terminal`
* Type the command `ip prefix-list _name_ description _string_` -> Optional: Adds an information string about the prefix list or `ip prefix-list _name_ [ seq number ] [{ permit | deny } prefix {[ eq prefix-length ] | [ ge prefix-length ] [ le prefix-length ]}]`

.Example: 
```
ip prefix-list static-UNTRUSTED_U2S seq 45 permit 10.128.128.0 le 24
show ip prefix-list _name_ -> to review the list
copy running-config startup-config
```
=== Configuring the Route in an existing Interface 

* To configure a new route inside the interface follow the steps below:
.Example: 
```
sh run vrf UNTRUSTED_U2S
conf t
vrf context UNTRUSTED_U2S
ip route X.X.X.X/X Vlan<id> IP next-hop address in format i.i.i.i
copy running-config startup-config
```

<<< 

== F5 

.BIG-IP Devices
|===
|DNS |IP |Description |Version

|MIVLB515 |10.128.126.176 https://10.128.126.176[GUI] |Production Active .4+.^|15.1.10.2 Build 0.44.2
|MIVLB514 |10.128.126.175 https://10.128.126.175[GUI] |Production Passive
|MIVLB513 |10.128.126.165 https://10.128.126.165[GUI] |PreProduction
|miobmplbs1 |10.133.225.126 https://10.133.225.126[GUI] |Virtualized on https://10.133.59.19/[GMIVCFE01] F5 Pro active 
|miobmplbs2 |10.133.225.127 https://10.133.225.127[GUI] |Virtualized on https://10.133.59.19/[GMIVCFE01] F5 Pro standby
|===

.Support
* https://supportcenter.lantech.it/LTG/[Lantech Support]
* e-mail:

=== Nodes description

image::images/nodeDescriptionF5.png[image,width=596,height=228]

https://my.f5.com/manage/s/article/K12213214[source] +
https://clouddocs.f5.com/training/community/f5cert/html/class1/modules/module3.html[source]

TIP: To deepen the information about the F5 go https://support.F5.com/csp/home[here]

=== Remediation of the header using the iRule Pro

.`iRule:/F5_FE-DMZ-ext/RemoveX-Header-Response_Irule`
* With the IP search in the virtual server list from ALL contextes
* Open the correspondent service
* Go to resources from the needed context, otherwise it will be in Read Only
* Pick the correct iRule then press finished

.From CLI
. `tmsh`
. `cd /FE-`<needed context>
. `list ltm virtual` if you need to find the name
. `modify ltm virtual [virtual_server_name] rules RemoveX-Header-Response_Irule`

.Some useful commands
* If a replacement is needed you can: `modify ltm virtual my_vs rules { my_irule }`
* If you need to find the iRule you can: `list ltm rule`

=== Find the devices in the F5 Production enviroment

.GUI
* Log into the GUI -> local traffic -> network map
* Select the partition ALL -> introduce in filter the IP or VM

.CLI
* Log into the F5 CLI and run `tmsh` 
* List items -> `cd / to root` -> `list /ltm node recursive <nodeName>`  
* Or this can run from bash: `tmsh -c "cd /; list /ltm node recursive" | grep -b2 <nodeName>`  
* To list all the nodes from all contextes run: `cd /`  
** `list /ltm node recursive`
* Once found the correct one run: `cd <context>`  
** `list /ltm node <nodeName>`  

TIP: From bash `tmsh -h` helps you with what to do, `tmsh --help` gives you detailed info
  
=== Verifying the TSL

.GUI
* Log into needed F5 and look for the server:
** Inside the server you should search for the advanced conf and see the available conf

.CLI
* Log into needed F5 and:
** Type `openssl s_client -connect VIP:port number`
** Example: `openssl s_client -connect 10.10.10.10:443 tslversion`  
* This command will verify all the certificates configured in the f5:
```
show /ltm profile client-ssl | grep -E "TLS|Ltm::ClientSSL" | grep -v 1.2 | grep -v DTLS | grep -v ' 0'
Output Example:
Ltm::ClientSSL Profile: pre-discovery.telcoItaly.it_cert
TLSv1.3 0-RTT
  TLS Protocol Version 1.0                                        1.6K
  TLS Protocol Version 1.1                                          91
  TLS Protocol Version 1.2                                       65.5K
  TLS Protocol Version 1.3                                           0
  DTLS Protocol Version 1                                            0
  DTLS Tx Pushbacks                                                  0
```
=== Patching Activity

* This activity runs from MIVLB515.private.it
* A notification mail must be sent to monitoring group to signal the beginning
* Turn off nodes as instructed from dedicated file depending on number: T71, T72 or T73
** Log in MIVLB515.private.it and run: `bash t7_all-main_v01.3.sh`
* Contact the needed collegue and comunicate that nodes are offline and activity can begin 
**

NOTE: Do not contact him through: company mail. He does not read it

* Terraneo will contact you back to ask you to turn on the nodes
* Once the nodes are back online notify Reply to verify.
** Rep Reply 349 213 9442 
** Alberto Steri 347 781 8763
** They will verify once the shift starts according to CEST time zone
* A notification mail must be sent to monitoring group to signal the end

> Insert sample and link to patching procedure. Or include it here
> The other T7 patching doc must be shipped together with this one or implemented here

NOTE: If problems occurs you can find documentation in consulences Onedrive inside Cyclic Patching folder

=== Modify the banner in F5 CLI

CAUTION: Do not take `vi` or `vim` https://vim.works/2019/03/03/emergency-vim-quickstart/[lightly]! Take sometime to read how to use it. https://www.adminschoice.com/vi-editor-quick-reference[Read me!]

.From F5's CLI
```
vi /config/ssh/ssh_banner
#Insert Banner 
________________________________________
             telcoItaly Italy

      This network is protected by
         a data security system

          Unauthorized access
          will be prosecuted.
________________________________________

Equipment: MIVLB513

Customer : telcoItaly

Descr.   : F5 BIG-IP LTM-I4600
________________________________________

tmsh modify /sys sshd include "Banner /config/ssh/ssh_banner"

tmsh save /sys config   #safe the config file
```

=== Rule configuration on LTM to accept incoming requests from specific IP 

.Example: 178.239.182.26 * CRM di Facile.it to a specific URL (https://scoprioffer.telcoItaly.it/api)
* If the public IP of the service is not available, use `nslookup` or press http://www.kloth.net/services/nslookup.php[nslookup site]
* Once the IP is obtained, find the corresponding private IP by querying the MIVFX900 firewall (10.133.121.141):

```Cisco
- MIVFX900-1 / DMZ / sec / act # show run nat
object network obj-10.129.166.36
 nat (LEGACY-DMZ, DSL_DATA) static 91.80.46.37 no-proxy-arp
```

==== From F5
.GUI
* Select "F5_FE_DMZ_ext" from the "Partion" drop-down menu
* From Main -> Local Traffic -> Virtual Server
* Put private IP 10.129.166.36, followed by wildcard `*`
* Click on the entry of the server with Service Port 443 (HTTPS)
* "Resources" from the horizontal menu above
* Select the text contained in the "Name" field under "iRules" and copy (Ctrl + C or right mouse button)
* Click on iRules from the menu on the left
* Paste in the search field the text previously copied followed by wildcard `*`

<<<

* Insert the new instruction in the iRule code. Example: 

```tcl
when HTTP_REQUEST {
  #CHG 84220
  switch [HTTP :: host] {

"discoveroffer.telcoItaly.it" -
"discoveroffer.voda.it" {
switch -glob [HTTP :: uri] {
"/ api *" {
if {([class match [IP :: client_addr] equals ministi02_Tool_https://eag.telcoItaly.com/vpn/index.html[EAG]LE_Reply_net]) or
([class match [IP :: client_addr] equals ministi02_Tool_VDL_net]) or
!!!!!!! new instruction inserted ---------> ([class match [IP :: client_addr] equals ministi02_CRM_Facile_it_net]) or <--------
 ([class match [IP :: client_addr] equals ministi02_Vola_net]) or
```

* Click on Update to save the changes
* Click on Pending Sync at the top left next to the F5 logo, to synchronize the changes made with the backup F5
* Select the line corresponding to the device with "Sync Status" in yellow from the Device box and click on the "Sync" button

=== Update User List for alsmobile

* Connect to the active F5 BIG-IP LTM https://10.128.126.176[GUI] `10.128.126.176` then import the file containing the user lists:

IMPORTANT: It has to be done from `Common` Partition

. Main -> System -> File Management -> Data Group File List 
** [line-through]#Check latest "App-Android_msisdn_users_v2" number, as of 20230705 is 19#
. Main -> System -> File Management -> Data Group File List -> Import (button on the right)
. "Choose file" button
. Pick "Overwrite existing"
. In "Name" pick: "App-Android_msisdn_users_v2"
. In "File Contents" select the "String" item
. In "Data Group Name" enter the name of the group: "App-Android_msisdn_users_v2"
. Import

// What about having Data Group Name empty? It won't be referenced from iRule

<<<

[.lead]
[.text-center]
The following text is no longer necessary, but can be useful

.`Update the reference to the Data Group File List in the iRule:`
. Main -> Local Traffic -> iRules
. Partition F5_FE-DMZ-Ext 
. Select the first iRule `APP-android_v2-http_iRule` 

CAUTION: Beware that there is another one is `s`, APP-android_v2-http**s**_iRule

[start=4]
. Modify line 6 `set static :: user_for_MSISDN "App-Android_msisdn_users_v19` with the updated value
. Click bottom left on Update

.`If F5 reports an error in compiling the file, proceed as follows:`
. Copy only line 1 of the file and paste it in the F5 box
. Click on Import
. Go to the .txt file, select all the lines except line 1 already copied
. Paste the selected lines in the F5 box
. Import

NOTE: It rarely happens but: If there is Pending Sync at the top left next to the F5 logo, click it to synchronize the changes made with the backup F5

// How can I do it from CLI? How can I delete older ones owned by root?

=== Implement ACL in F5

* Find out service name:
. from `cmd` run: `nslookup <URL/FQDN> without https and without trailing /`
. pick up the public IP and log into the firewall `10.133.121.142` `MI-VFX901`
. from DMZ context look for the local IP: show nat | i `<publicIP>`
* Look up the ACL group:
. login into F5, PRE or PRO depending on the request
. Click the Virtual Servers on the left menu
. From top right select All[Read only] partition
. Put the private IP in the search bar surrounded by wildcards `*`
. From Resources Tab the iRules, always choose the `https` secure one
. Look in each iRule the name, it's usually after "equal" inside the TCL script
. From the left menu Local Traffic -> iRules -> Data Group List
. Change partition to needed one
. Put iRules name in the search bar surrounded by wildcards `*`
. From the CMatrix get the IP and put it in Address
. From the CM get the Note cell and put it in Value
. Press Add and Update
. Repeat the last steps until all the IPs are added
* Answer the e-mail

// A video procedure would be nicer

=== Create a Virtual Server (GUI)
* Go to F5 GUI, inside Virtual Server -> Create. 
* Follow the images below to continue the configuration

image::images/virtualServer1.png[image,width=596,height=228]

image::images/virtualServer2.png[image,width=596,height=228]

image::images/virtualServer3.png[image,width=596,height=228]

image::images/virtualServer4.png[[image,width=596,height=228]

image::images/virtualServer5.png[image,width=596,height=228]

.Pool Creation 
image::images/virtualServer6.png[[image,width=596,height=228]

.If it is a new Pool
image::images/virtualServer8.png[image,width=596,height=228]

.If are available, please check from Node List
image::images/virtualServer9.png[image,width=596,height=228]

.Then, associate Pool and Default Persistence profile to Virtual Server
image::images/virtualServerA.png[image,width=596,height=228]

.Health Monitor Check
image::images/virtualServerB.png[image,width=596,height=228]

.New Client SSL profile creation
image::images/virtualServerC.png[image,width=596,height=228]

image::images/virtualServerD.png[image,width=596,height=228]

// A video would be nicer

=== Update or Upgrade BIG-IP 

* For more information go to the F5 https://my.f5.com/manage/s/article/K84205182[guide] or follow the https://www.f5.com/pdf/deployment-guides/bigip-update-upgrade-guide.pdf[manual]
* A case to https://supportcenter.lantech.it/LTG/[Lantech] must be opened in order to retrieve the updates. 

* If it's an HA (High Availability) Active Stand-by configuration:
** Start from Standby device 
** In case of configuration changes: `cpcfg --source=<volumeA> <volumeB>`
** Disable automatic Sync in order to prevent sync errors from the different installed versions
*** Check actual status: `tmsh list /cm device-group` or `tmsh list /cm device-group Device-group-1`
*** Disable auto-sync: `tmsh modify /cm device-group Device-group-1 auto-sync disabled` and save `tmsh save /sys config`

CAUTION: Once Automatic Sync is disabled, the configuration changes must be manually synchronized. 

.Update Steps CLI
* Push the needed isos to the path `/shared/images`
* Go as root to the path `/shared/images`
* Check volume software: `tmsh show sys software` to view software informations or list the images: `tmsh list sys software image`
* Create the new volume for the new iso: `tmsh install sys software image <BIG-IP image ISO name> volume <volume_name> create-volume`
** If you need to install an Hotfix: : `tmsh install sys software hotfix <BIG-IP hotfix-name.hotfix> volume <volume_name> create-volume` 

TIP: If you get space error you have to remove an old volume: `tmsh delete sys software volume <volume_name>`

* Check install status: `tmsh show sys software status` or `watch -n 30 "tmsh show sys software status"`
* Reboot into the new volume: `tmsh reboot volume <volume_name>`

WARNING: After you enter this command, the system immediately begins restarting. The system drops all existing connections and does not pass traffic until the restart completes and the BIG-IP configuration loads.

.In case of configuration changes in the volume
* Use the following syntax to copy the configuration from the current active configuration to the new boot location, prior to restarting and booting into the new volume: `cpcfg --source=<volumeA> <volumeB>`

=== F5 Failover

To initiate a Manual Failover from the currently Active HA Peer BIG-IP in the Traffic Group, the following steps can be performed:

.GUI Failover:
. Log in to the active BIG-IP as the administrator
. Click the Active link in the upper left hand corner next to the F5 Ball and Online. This is a shortcut link that takes you directly to Device Management > Traffic Group and into the Traffic Group for which the BIG-IP is currently the Active HA Peer BIG-IP.  
. Near the bottom of the Traffic Group's config page, click the Force to Standby button to initiate the Manual Failover. And watch the HA Role of that BIG-IP move into the Standby HA Role in the upper left hand corner next to the F5 Ball and Online.

.Reach the active `MIVLB515.private.it` as shown below:
image::images/failoverF5.png[image,width=596,height=228]

.Inside Devices -> Change the Description and Press force `Stand by`
image::images/failoverF5n2.png[image,width=596,height=228]

.CLI Failover:
. Log in to the active BIG-IP CLI as the administrator.
. Navigate to the LTM module by typing `tmsh`.
. Check the current state of the devices by running the command `show sys failover`.
. Trigger the failover with `run sys failover standby`.

<<<
  
=== About Data-Group

==== Search data-group in F5 CLI
* Go to the needed enviroment PRE or PROD
* From `tmsh` run :`cd /`
* To search the context where the data-group is stored type `list ltm data-group recursive | grep data-groupName`
** Example: `list ltm data-group recursive | grep TiTCare-PRE_net`
* Then to get the info needed from the data-group `list ltm data-group internal data-groupName`
** Example: `list ltm data-group internal TiTCare-PRE_net`

==== Add IPs to a data-group in F5 from GUI
Inside the excel take the URL do `nslookup xyz.telcoItaly.it`

.Example:
```powershell
  PS C:\> nslookup backoffice.telcoItaly.it
Server:  ns-office-it2.telcoItaly.com
Address:  10.21.100.239 --> Priv IP

Name:    backoffice.voda.it
Address:  91.80.46.172
Aliases:  backoffice.telcoItaly.it
```

NOTE: With the Public IP go to the DMZ context in ASA, and run a `sh nat | i <publicIP>`. DMZ context is used because ther is NAT  

.Example:
```Cisco
MIVFX900-1/DMZ/pri/act#  sh nat | i 91.80.46.172
36 (LEGACY-DMZ) to (DSL_DATA) source static obj-10.129.166.149 91.80.46.172  no-proxy-arp
```

* With the IP given from the ASA go to F5 Network map with partition: All. Be aware of the port you need, 80 or 443
* Take the Virtual Server name
* Search in the VS List the name you got from the prior step -> Resources -> click on the iRule, it leads you to the Properties of the iRule, read what it says and select the Datagroup
* Then go inside iRules -> Datagroup List -> Paste the datagroup.  
** Example: `Backoffice_BE190_net`
* Go inside the datagroup and Add the needed IPs
* Remember: to comment the added IPs using the Value option
* Press Add and Update to save the changes

IMPORTANT: In some cases you wil have more `data-groups` inside the `iRule`, verify the name from the CM, in some cases the IP has to be add into a `object-group`, in others a new `data-group` must be created

==== Add/Remove IPs to a data-group in F5 from CLI

.To add

* A single entry
** `tmsh create /ltm data-group internal <datagroup_name> records add { <entry_value> }`
* Multiple entries at once
** `tmsh create /ltm data-group internal <datagroup_name> records add { <entry1_value> <entry2_value> ... }`

.To remove

* A single entry
** `tmsh delete /ltm data-group internal <datagroup_name> records delete { <entry_value> }`
* Multiple entries at once
** `tmsh delete /ltm data-group internal <datagroup_name> records delete { <entry1_value> <entry2_value> ... }`

* Example:

```
[zzyourUser@MIVLB515:Active:In Sync] ~ # tmsh
cdzzyourUser@(MIVLB515)(cfg-sync In Sync)(Active)(/Common)(tmos)# cd /
zzyourUser@(MIVLB515)(cfg-sync In Sync)(Active)(/)(tmos)# cd F5_FE-DMZ/
zzyourUser@(MIVLB515)(cfg-sync In Sync)(Active)(/F5_FE-DMZ)(tmos)# modify /ltm data-group internal TiTCare-pro_net records 
Options:
  add                delete             modify             none               replace-all-with
zzyourUser@(MIVLB515)(cfg-sync In Sync)(Active)(/F5_FE-DMZ)(tmos)# modify /ltm data-group internal TiTCare-pro_net records add/delete {n.n.n.n}
```

==== Add a new data-group to the F5 

.Example: CM 8.18
```powershell
PS C:\Windows\system32> nslookup scopriofferta.telcoItaly.it
DNS request timed out.
    timeout was 2 seconds.
Server:  UnKnown
Address:  10.21.100.239

Name:    scopriofferta.voda.it
Address:  91.80.46.37
Aliases:  scopriofferta.telcoItaly.it

Private IP
10.129.166.36

VS name
minisiti02pro-discovery_HTTPS_vs

iRule
/F5_FE-DMZ-ext/minisiti02pro-discovery_HTTPS_iRule
```

In this case once we get to the iRule we noticed there is no datagroup that corresponds to the service needed in the Cm so we proceed to create it

* Log in the F5 GUI -> go to iRules -> select Data-group -> create the name -> select a type in this case was `address` -> add the IP address needed and the value, a comment -> press Update

==== Add the datagroup inside the needed iRules:
. Data-group name = `minisiti02_CRM_Smart_Contact_net`
. IP address = `51.77.222.142`
. Line added to the iRule referring to the datagroup = `([class match [IP::client_addr] equals minisiti02_CRM_Smart_Contact_net]) or`

=== Removing a host from node/pool list 

NOTE: To do this task you must have the node and pool name, to fetch those go to the Network Map 

* Go inside the pool list, search the needed pool and direct to the right context finally remove the node from the pool
* After that direct to the node list, search the node and delete it

=== Check if nodes has traffic 

* Inside the F5 GUI, go to statistics -> Module Statistics from there search the needed pool and go to local traffic. As shown in the below example: 

image::images/trafficInNodes.png[image,width=596,height=228]

NOTE: Remember to be in All contexts 

<<<

== DNS BIND9

.DNS devices
|===
|DNS |IP |Role

|mi5fdsx008 |10.128.123.5 |DNS master
|osx101v |10.129.166.21 .2+.^|DNS Public / External
|osx102v |10.129.166.22 
|osx103v |10.129.169.21 .2+.^|DNS Private / Internal
|osx104v |10.129.169.22 
|===

TIP: DNS System Official Documentation https://www.isc.org/bind/[BIND 9]

=== Insert or Delete a Record inside the server BIND 9 DNS Master (Internal sync)

==== CLI

* Log into `mi5fdsx008`
* Path is: `cd /var/named/addr`
* Check db: `grep -R <regex> *`

[cols="35%,80%"]
|===
|Description |Commands

.2+|Serial number update
|Test: `sed -E -n "s/[0-9]{8}/$(date +%Y%m%d)/p" ternal/db.voda.it`
m|sed -E -i "s/[0-9]{8}/$(date +%Y%m%d)/" ternal/db.voda.it

.2+|Comment
|Test: `sed -n '/bookinglearn/s/^/;/p' ternal/db.voda.it`
m|sed -i '/bookinglearn/s/^/;/' ternal/db.voda.it

.2+|Uncomment
|Test: `sed -n '/\^;bookinglearn/s/^;//p' ternal/db.voda.it`
m|sed -i '/\^;bookinglearn/s/^;//' ternal/db.voda.it

.2+|Add a line after a specific regex pattern
|Test: `sed -n '/regex/a\new_line' ternal/db.voda.it`
m|sed -i '/regex/a\new_line' ternal/db.voda.it

.2+|Add a line after a specific line number
|Test: `sed -n '4a\bookinglearn' ternal/db.voda.it`
m|sed -i '4a\bookinglearn' ternal/db.voda.it

.2+|Append a line
|Test: `sed -n '$a\bookinglearn' ternal/db.voda.it`
m|sed -i '$a\bookinglearn' ternal/db.voda.it
|===

Commit changes: `rndc reload`

IMPORTANT: Update serial number date on Master every time it gets modified. Otherwise it does not update the slaves.

> 20230705 This does sync all the slaves!!!!!!!!!

==== Monkey CLI

```
@                       86400   IN      SOA     dns1.private.it. postmaster.private.it.
                                                2023032001      ; serial number
                                                3600            ; refresh [1h]
                                                600             ; retry [10m]
                                                1209600         ; expire[14d]
                                                3600            ; min TTL [1h]

@                       86400   IN      SOA     dns1.private.it. postmaster.private.it.
                                                2023032001      ; serial number
                                                3600            ; refresh [1h]
                                                600             ; retry [10m]
                                                1209600         ; expire[14d]
                                                3600            ; min TTL [1h]
```

.This process allows to replicate the files "DB" in the DNS to the two external and the two internal slaves osx101-2-3-4v
. Log into server Master `MI5FDSX008` as root
. Use `grep -R <regex> <filename/*>` to check if the info has to be added in another db
. Edit the relative file to the zone that has to be modified. 
  * Example: 
  * `vi /var/named/addr/internal/<dbFileName>`
  * `vi /var/named/addr/external/<dbFileName>`

CAUTION: Do not take `vi` or `vim` https://vim.works/2019/03/03/emergency-vim-quickstart/[lightly]! Take sometime to read how to use it. https://www.adminschoice.com/vi-editor-quick-reference[Read me!]

[start=4]
. Update the Serial Number in all the db's you are working, internal, external.
. Run `rndc reload` to restart the service and apply latest changes

CAUTION: Do not execute the following process. It leads to unsynchronized slaves and loss of changes. Because if changes aren't saved in the master, once restarted it imposes its own version. 

[.lead]
[.text-center]
The following is informative

.**Ultra monkey**, single files on each slave
. Log in the needed DNS slave osx101-2-3-4v
. Go to `cd /var/named/slaves/external/`
. Open the file with `vi <db.name>`
. Commit changes: `service named restart`, in order to verify: `service named status`

.Alternative route to DNS
* Log into nexus 5k MIVMX904 or MIVMX905
* Connect to DNS internal or External using `ssh zzbicchieri@10.129.166.21 vrf <vrfName>` 
* Gain admin privileges `sudo su - `
* Look for needed info: `grep <regex> /var/named/slaves/internal/*`

==== DNS decommission on telcoItaly.it

. To decommission a domain inside telcoItaly.it the client must make the request in https://telcoItaly.sharepoint.com/sites/V-DNA?SafelinksUrl=https%253a%252f%252ftelcoItaly.sharepoint.com%252fsites%252fV-DNA&SafelinksUrl=https%3A%2F%2FtelcoItaly.sharepoint.com%2Fsites%2FV-DNA&sdata=NHU4TzAxYzRyTHo1enJTSVBtbU43MGcxMG5BeEFyRmpvazZ5MEVCam5Idz0%253d&xsdata=MDV8MDJ8Z2FicmllbGUuc2Fyb25uaUB2b2RhZm9uZS5jb218Yjc4NTYxY2UxODgwNGI2NzI3NTMwOGRjZDNjMGRhNTF8NjgyODNmM2I4NDg3NGM4NmFkYjNhNTIyOGYxOGI4OTN8MHwwfDYzODYxODA3MjUwNDI2NzA0NXxVbmtub3dufFRXRnBiR1pzYjNkOGV5SldJam9pTUM0d0xqQXdNREFpTENKUUlqb2lWMmx1TXpJaUxDSkJUaUk2SWsxaGFXd2lMQ0pYVkNJNk1uMD18MHx8fA%253d%253d[V-DNA Home]

<<<

== MTA Sendmail (Now Proofpoint)

.DNS devices
|===
|DNS |IP |Description

|mta_vs |10.129.166.19 |vIP external
|osx101v |10.129.166.21 .2+.^|MTA external
|osx102v |10.129.166.22 
|mta-int_vs |10.129.166.20 |vIP internal
|osx103v |10.129.169.21 .2+.^|MTA internal
|osx104v |10.129.169.22 
|===

NOTE: MTA = Mail Transfer Agent, it runs on port 25 and yes, same devices as DNS

> RHEL 6 configuration of https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/s2-email-mta-sendmail#doc-wrapper[Sendmail]
> Official Proofpoint https://www.proofpoint.com/us/products/email-protection/open-source-email-solution[website]

=== Add new Recipient

. Login to the two servers, osx101v and osx102v
. `cd /etc/mail`
. Add the new recipient: `echo "@net.telcoItaly.it       MailtelcoItaly:[10.129.166.20]" >> /etc/mail/smarttable`
. Rebuild the hash database file `makemap hash /etc/mail/smarttable.db < /etc/mail/smarttable`
. Restart the Sendmail service for the changes to take effect: `service sendmail restart`

=== Edit Mail Files

* Files can be `/etc/mail/`: 
** access
** smarttable
* Make a backup of the current `/etc/mail/<file>` as showed `cp /etc/mail/<file> /etc/mail/<file>.bak`
* Edit the `/etc/mail/<file>`
** https://vim.works/2019/03/03/emergency-vim-quickstart/[VIM]
** If you need to append a line to the file you can `echo "@net.telcoItaly.it       MailtelcoItaly:[10.129.166.20]" >> /etc/mail/smarttable`
* Rebuild the hash database file: `makemap hash /etc/mail/<file> < /etc/mail/<file>`
* Restart the Sendmail service for the changes to take effect: `service sendmail restart`

=== Migrate MTA destination (Untested)

. Install the necessary TLS libraries: `$ sudo yum install openssl openssl-devel`
. Edit the MTA configuration file to enable TLS 1.2:
  * If you are using Postfix, you can edit the `/etc/postfix/main.cf` configuration file and add the following lines:

```bash
smtpd_tls_security_level = may
smtpd_tls_protocols = !SSLv2,!SSLv3,!TLSv1,!TLSv1.1, TLSv1.2
smtpd_tls_mandatory_protocols = TLSv1.2
smtp_tls_protocols = !SSLv2,!SSLv3,!TLSv1,!TLSv1.1, TLSv1.2
smtp_tls_mandatory_protocols = TLSv1.2
```

  * These lines set the minimum allowed TLS protocol version to 1.2 for both incoming and outgoing connections.
. Restart the MTA service: `$ sudo systemctl restart postfix`
. Test the TLS configuration:
  * TLS scanning tool like SSL Labs or Qualys SSL Labs can be used to test the TLS configuration of your MTA and check if it has valid certificates. You can also use a network sniffer like `tcpdump` to capture and analyze the network traffic between the server and the clients to verify that the traffic is encrypted with TLS.
  * A TLS certificate is needed in order to use TLS encryption with your MTA. The certificate will be used to authenticate the server to clients and establish a secure connection.

=== Verify The log MTA

. Connect to the machines: `osx101v.private.it 10.129.166.21` and `osx102v.private.it 10.129.166.22`

TIP: These machines can be reached from Ansible itmi3pans001 `10.133.59.24`

[start=2]
. Log in as root and check the logs in `/var/log/mailog-`
. Look for needed info: `zgrep <regex> /var/log/*`
* If needed to unzip gz files run: `gunzip maillog.1.gz`
. The activity of each individual mail delivery is identified by a code:

```log
Mar  9 09:22:19 osx101v sendmail[100119]: STARTTLS=client, relay=smtp.telcoItaly.arubamail.it., version=TLSv1/SSLv3, verify=FAIL, cipher=DHE-RSA-AES256-SHA, bits=256/256

Mar  9 09:22:19 osx101v sendmail[100119]: 1298MECF100117: to=<vo-monitorcb@vola.it>,<redcarpet.1821@mail.telcoItaly.it>, delay=00:00:00, xdelay=00:00:00, mailer=telcoItaly, pri=171351, relay=smtp.telcoItaly.arubamail.it. [62.149.178.100], dsn=5.0.0, stat=Service unavailable

Mar  9 09:22:19 osx101v sendmail[100119]: 1298MECF100117: 1298MJCF100119: DSN: Service unavailable
```

or

```
Mar  9 09:37:32 osx101v sendmail[101076]: 1298bRqr101076: ruleset=check_rcpt, arg1=<test_qualysscan@smtpcheckqualys.smtp>, relay=sn001.s01.sea01.qualys.com [64.39.106.101] (may beforged), reject=550 5.7.1 <test_qualysscan@smtpcheckqualys.smtp>... Relaying denied. IP name possibly forged [64.39.106.101]

Mar  9 09:37:32 osx101v sendmail[101076]: 1298bRqr101076: from=<qualysscan_test@smtpcheckqualys.smtp>, size=0, class=0, nrcpts=0, proto=SMTP, daemon=MTA1-private, relay=sn001.s01.sea01.qualys.com [64.39.106.101] (may be forged)

Mar  9 09:37:32 osx101v sendmail[101076]: 1298bRqs101076: ruleset=check_rcpt, arg1=<qgmrtest%qualysguard.com@[91.80.46.120]>, relay=sn001.s01.sea01.qualys.com [64.39.106.101] (maybe forged), reject=550 5.7.1 <qgmrtest%qualysguard.com@[91.80.46.120]>... Relaying denied. IP name possibly forged [64.39.106.101]

Mar  9 09:37:32 osx101v sendmail[101076]: 1298bRqs101076: lost input channel from sn001.s01.sea01.qualys.com [64.39.106.101] (may be forged) to MTA1-private after rcpt

Mar  9 09:37:32 osx101v sendmail[101076]: 1298bRqs101076: from=<qgmrfrom@[91.80.46.120]>, size=0, class=0, nrcpts=0, proto=SMTP, daemon=MTA1-private, relay=sn001.s01.sea01.qualys.com [64.39.106.101] (may be forged)
```

<<<

== Squid Proxy

.Proxy devices
|===
|DNS |IP |Role |Version

|osx100v |10.129.166.100 |Proxy Active .3+.^|4.15
|osx222v |10.129.166.102 |Proxy Standby
|Proxy VIP |10.129.166.101:8080 | Balanced on F5
|===

=== Proxy Squid Configuration
* Connect to Ansible through https://eag.telcoItaly.com/vpn/index.html[EAG]
* Check on ASA Firewall inside DMZ context
* If there are ACLs towards the service port add: `access-list GLOBAL_ACL extended permit tcp host 10.129.166.102 any4 eq 8226`
* From itmi3pans001 log into 10.129.166.100 aka osx100v
* With root access create file in `/etc/squid/`
* Insert domains in the file: `allowed-ACL_NAME.squid`
* Edit the file:

CAUTION: Do not take `vi` or `vim` https://vim.works/2019/03/03/emergency-vim-quickstart/[lightly]! Take sometime to read how to use it. https://www.adminschoice.com/vi-editor-quick-reference[Read me!] 

```bash
[root@osx100v squid]# vi allowed-win_act.squid
# YYYYMMDD 
# If edited after creation keep track of it with: YYYYMMDD_v0.1
.microsoft.com  
.windowsupdate.com
.windows.com
```

* Edit `/etc/squid/squid.conf` file and add the following:
** For one or more IPs search the needed rule and add it `x.x.x.x/32` 
** In the case of adding a rule follow the example below to configure it

```bash
#########################################################
# Win Activation YYYYMMDD
acl Win_Act src 10.128.124.15/32 10.128.124.16/32 
acl Win_Sites dstdomain "/etc/squid/allowed-win_act.squid"
http_access allow Win_Act Win_Sites
######################################################### 
```

* Check at the beginning of the file if the destination port it's inside the ACL
** Example: acl SSL_ports port 8226
** You can find the line with: `grep {portNumber} {fileName}`
* Restart the service: `service squid restart`

IMPORTANT: Mirror the configurations on `osx222v 10.129.166.102`

.Test it
```bash
[root@osx222v squid]# tail -fn 100 /var/log/squid/access.log | grep api.think4u.cloud
07/Jun/2021:16:49:35 +0200     23 10.129.166.112 TCP_MISS/503 0 CONNECT api.think4u.cloud:8226 DIRECT/151.8.211.133
07/Jun/2021:16:50:20 +0200      0 10.129.166.112 TCP_MISS/503 0 CONNECT api.think4u.cloud:8226 DIRECT/151.8.211.133

[root@osx222v squid]# grep api.think4u.cloud /var/log/squid/access.log
```
NOTE: In case the implementation doesn't work check if the source IP's added to the proxy are configured inside ASA

==== Useful Squid Commands 
To restart and control the status of the proxy `systemctl restart squid && systemctl status squid`

==== How to read needed files
* Unzip all the folder: `unzip -d . squid_osx100v_20221028.zip`
* Open it: `less etc/squid/squid.conf`
* Look at files inside zip: `unzip -l squid_osx100v_20221028.zip`
* Unzip only squid.conf: `unzip -j squid_osx100v_20221028.zip etc/squid/squid.conf -d .`
* Open it: `less etc/squid/squid.con`

<<<

== Certificates Renewal

IMPORTANT: Please notice this important step before asking to renew a certificate

* The FQDN should be resolved from a DNS, public and/or private. You can use this public tool to verify if the service is resolved in Public DNS: https://www.infobyip.com/ipbulklookup.php[Domain and IP bulk lookup tool]
* You can use “nslookup” from telcoItaly internal network to verify if it is resolved in Internal DNS.
* The certificate can be renewed if the service is resolved at least in one of the 2 DNS (public or internal).
* Check inventory if date is set to 01/01/1970 that means dismissed

NOTE: In case it results dismissed please update the inventory.

=== Update notification mail of certificates about to expire (FastDelivery - Certificates - Expiring Date)

* Log into gminnms116, inventory's device as root
* edit file `/home/oracle/scripts/certificates/check_certificate.sh` at line 63

TIP: Any changes to be made to that mail can be done from that script

=== Folder on pans
. Connecto to EAG
. SSH to `10.133.59.24` `itmi3pans001` with preferred application
. Gain root privileges. (`su`)
. `/home/ansysad/certsFD`
. `ls -lrth`
. The last file, right above the terminal is the needed certificate
. `sudo cp <cert> /home/zzYOURUSER` or `sudo zip /home/zzYOURUSER/certs.zip *keyWord` make a zip with all the needed certificates
. SFTP the cert out of the home directory in itmi3pans001. I strongly suggest to use MobaXterm with the shared configuration

// Anybody is free to make an easy fetch script

=== Extract pem and key from pfx

* Get the pem file: `openssl pkcs12 -in vola_account_prod.pfx -out vola_account_prod.pem -nodes`
* Extract the key: `openssl rsa -in vola_account_prod.pem -out vola_account_prod.key`

=== Create private key and CSR (common to all SHA2 type certificates)
. Create CSR in PEM format and KEY.
.. `cd` into configuration files' folder
.. Edit `vi openssl-XXX.conf` depending on certificate type using CN or DSN if there's SAN.
* `openssl-SHA2.conf`
* `openssl-SHA2-SAN.conf`
* `openssl-SHA1-PRV.conf`
. SHA2 commands: `openssl req -new -newkey rsa:2048 -nodes -sha256 -out common_name.csr -keyout common_name.key -config <openssl-SHA2-??.conf>`
. SHA1 commands: `openssl req -new -newkey rsa:2048 -nodes -sha1 -out abthq-pre.telcoItaly.it.csr  -keyout common_name.key -config openssl-SHA1-PRV.conf`
. Insert Common_Name when prompted, do not put password
. Check if `.csr` and `.key` are inside the certificate's folder

=== Check CSR content
. Run `sslshopper` or similar and check it with https://www.ssl247.it/support/tools/csr-decoder[decipher]
. Copy file content `.csr` and check if the received fields are correct.
. <<_ca_private_telcoItaly_signature, CA Private telcoItaly Signature>>
. <<_ca_private_fastdel_signature, CA Private FastDel Signature>>

=== Archiving
. Inside FD's shared folder `\\ovlfs01\07-Sicurezza\RINNOVO CERTIFICATI\ARCHIVIO\` 
. Create a new folder with the naming convention `<__num.ticket__>-<__common name__>` (eg `R17100-tdmauth.telcoItaly.it`)
. Put inside `.csr` e `.key` files
. Delete what has been created locally at first step.

=== CA Public telcoItaly Signature
. Reach https://telcoItaly.sharepoint.com/sites/PKI/SitePages/Public%20Trust%20-%20Web%20Server.aspx?xsdata=MDV8MDJ8Z2FicmllbGUuc2Fyb25uaUB2b2RhZm9uZS5jb218NjUwZDBhNGUyNDdjNDE4MzkyYzEwOGRkYjNlMDEzZGN8NjgyODNmM2I4NDg3NGM4NmFkYjNhNTIyOGYxOGI4OTN8MHwwfDYzODg2NDQ5NzI1NjYxNzQ4MHxVbmtub3dufFRXRnBiR1pzYjNkOGV5SkZiWEIwZVUxaGNHa2lPblJ5ZFdVc0lsWWlPaUl3TGpBdU1EQXdNQ0lzSWxBaU9pSlhhVzR6TWlJc0lrRk9Jam9pVFdGcGJDSXNJbGRVSWpveWZRPT18MHx8fA%3d%3d&sdata=eEcydU4zTkdmRWQvQmJRTnI5YVdzeUo4bmd4OHQ0d0p1SkUwV3gvbVI5OD0%3d[website]
. Click on "standard SSL" if the certificate has one DNS only -> "Order now" 
. Click on "Multi-domain SSL" if there are more than one DNS -> "Order now" 
. Compile like below (Answers are inside "certificate request" ticket):

image:imagesCreateCert/image1.png[image,width=752,height=470]

image:imagesCreateCert/image2.png[image,width=752,height=984]

image:imagesCreateCert/image3.png[image,width=752,height=984]

image:imagesCreateCert/image4.png[image,width=752,height=984]

==== Additional e-mails

mailto:alfredo.sartacci@telcoItaly.com[alfredo.sartacci@telcoItaly.com]

."Specify the environment". Specify Prod if the certificate is production, Pre-prod if it is PreProduction
image:imagesCreateCert/image5.png[image,width=752,height=471]

[start=5]
. Click on submit and send email to mailto:alfredo.sartacci@telcoItaly.com[alfredo.sartacci@telcoItaly.com] asking for approval. +

<<<

=== CA Private telcoItaly Signature

.Connect with https://enrol.pki.telcoItaly.com/aspx/certificate/CertificateIssuancePkcs10View.aspx[domain] user
image:imagesCreateCert/image7.1.png[image,width=758,height=537]

. If the device is PRO, leave "Web Server Certificate - Production" selected in the first field.
. Copy what was created above into the second field.
. In the SAN field specify DNS/SAN list.
* If there is one CN only put it inside the field anyway.
. In "Request/Service Description" specify a generic value: "web service"
. Local Market/Country: "IT"
. Operational/Delivery/Service Owner's and Business Owner's Email address specify: mailto:vasFDcertificati@internal.telcoItaly.com[vasFDcertificati@internal.telcoItaly.com]
. Required Contacts: mailto:dl_vasfdops@telcoItaly.com[dl_vasfdops@telcoItaly.com]; mailto:alfredo.sartacci@telcoItaly.com[alfredo.sartacci@telcoItaly.com]; mailto:DL-VAS-Fast-Delivery@telcoItaly.com[DL-VAS-Fast-Delivery@telcoItaly.com]
. Keep track of request's number putting it inside the previously created share 
. You'll receive certificate by the e-mail.

.As shown below:
image:imagesCreateCert/image7.png[image,width=526,height=270]

<<<

=== CA Private FastDel Signature
Once generated the CSR, common procedure to all certificates, and checked the correctness, to sign the CSR on CA FastDel:

IMPORTANT: root privileges needed.

. `cd /app/causer`. 
. Move `.key` e `.csr` into `/app/causer`: `cp *.csr *.key /app/causer/`
. The command depends on the certificate:
* Server type:
** SERVER SHA2: `openssl ca -config openssl-FD.conf -in <file_richiesta.csr> -out certs/<cn_specified_in_the_request>.crt -policy policy_loose -extensions server_cert`
** SERVER SHA1: `openssl ca -config openssl-FD.conf -md sha1 -in <file_richiesta.csr> -out certs/<cn_specified_in_the_request>.crt -policy policy_loose -extensions server_cert`
* Client type:
** CLIENT SHA2: `openssl ca -config openssl-FD.conf -in <file_richiesta.csr> -out certs/<cn_specified_in_the_request>.crt -policy policy_loose -extensions usr_cert`
** CLIENT SHA1: `openssl ca -config openssl-FD.conf -md sha1 -in <file_richiesta.csr> -out certs/<cn_specified_in_the_request>.crt -policy policy_loose -extensions usr_cert`
* LDAP type:
** LDAP SERVER SHA2: `openssl ca -config openssl-FD.conf -in <file_richiesta.csr> -out certs/<cn_specified_in_the_request>.crt -policy policy_loose_LDAP -extensions server_cert`
** LDAP SERVER SHA1: `openssl ca -config openssl-FD.conf -md sha1 -in <file_richiesta.csr> -out certs/<cn_specified_in_the_request>.crt -policy policy_loose_LDAP -extensions server_cert`
** LDAP CLIENT SHA2: `openssl ca -config openssl-FD.conf -in <file_richiesta.csr> -out certs/<cn_specified_in_the_request>.crt -policy policy_loose_LDAP -extensions usr_cert`
** LDAP CLIENT SHA1: `openssl ca -config openssl-FD.conf -md sha1 -in <file_richiesta.csr> -out certs/<cn_specified_in_the_request>.crt -policy policy_loose_LDAP -extensions usr_cert`
. Once executed CA Fast-Del's passphrase is prompted, after that answer `Y` to the following requests.
.. The certificate will be archived into `/app/causer/certs`
.. Copy it inside the path where we created `.key` and `.csr`
.. Create `.pfx`
.. Archive everything in the share.

NOTE: If there are problems with the certificate signature (crt) it's necessary to revoke the certificate before to try again:
`cd /app/causer/ \ openssl ca -revoke <certificate_name>.crt -config openssl-FD.conf`

=== Signed certificate reception, comunication and archiving
The certificate has to be checked and has to be aligned with the request. If it isn't it has to be requested or signaled via e-mail

. Create file `.pfx` (PKCS12): `openssl pkcs12 -export -in common_name.crt -inkey common_name.key -out common_name.pfx`

CAUTION: Sometimes the certificate has dots "." replaced by underscore "_". + Leave password field empty

==== In case the file PFX creation fails
. Create a `.PEM` file in order to create the `.PFX`
. It happens often that CA Private telcoItaly sends a new signed certificate in binary format (DER) instead of PEM.
. To check if it's in binary look at the file with `less`

.It it's shown in this way it has to be converted in PEM format
image:imagesCreateCert/image8.png[image,width=526,height=270]

<<<

If there isn't any DER it will be:
```
-----BEGIN CERTIFICATE-----
MIIGUjCCBTqgAwIBwoTxI0xurZiqhkiG9w0BAQsFADBN
MQswCQYDVQMBGlnaUNlcnQgSW5jMQYDVQQDEx5E
aWdpQ2VydCBTSEEyIFwHsAxMjE1MDAwMDAwWhcN
MwCQYDVQQGEwJHQjEQMA4dsBxMHTmV3YnVyeTEo
-----END CERTIFICATE-----
```

[start=4]
. Convert the file to binary: `openssl x509 -inform der -in <certificate-name-DER> -out common_name.pem`
. Generate pfx file with `.PEM` file: `openssl pkcs12 -export -in <common_name.pem> -inkey common_name.key -out common_name.pfx`
. Open SFTP client in order to upload the valid certificate and the `.pfx` inside FastDelivery share
. Compress the following files with pass password (`.7z` or `.zip`): 
* Key
* CSR
* CRT (certificate)
* CA certificate (If it's DigiCert0 two are needed, root and middle)
* PFX
* Eventual PEM
. zip: `zip -p <password> <my_file>.zip <whatIwanToZip>`
. 7z: `7z a -r <my_file>.7z <whatIwanTo7zip> -p<"password">`

.Example:
image:imagesCreateCert/image9.png[image,width=459,height=242]

.Attach the 3 CA based on which CA they come from:

|===
|Public CA telcoItaly - DigiCert |Private CA telcoItaly |CA FastDel

a|
.DigiCertCA.crt
image:imagesCreateCert/cert.png[image,width=159,height=42] 
a|
.telcoItaly_Internal_Root_CA.crt
image:imagesCreateCert/cert.png[image,width=159,height=42] 

.telcoItaly_Internal_CA.crt
image:imagesCreateCert/cert.png[image,width=159,height=42]

a| 
.CA-FastDel.crt
image:imagesCreateCert/cert.png[image,width=159,height=42]

|===

[start=9]
. Send an e-mail to whom requested the certificate to inform it's ready. Specify expire date and wait installation instructions.

IMPORTANT: Do not send PRO's certificates unless directly expressed by the Project Manager 

[start=10]
. Update expiring dates on the 2 excel files

=== Certificate install on systems

[.lead]
After receiving confirm to install the certificates on the systems, we can have three different installation typologies

<<<

==== In case CRT file is not working on NGINX (VOLA) 

. When the error after the `systemctl restart nginx` shows this:

image:images/nginxERROR.png[image,width=459,height=242]

[start=2]

. You need to autogenerate a new crt file `openssl x509 -inform DER -in certificate.crt -text -noout`

. To check the file use the following command `openssl x509 -in certificate.crt -text -noout`

. Change the name of the crt file using `mv certificate.crt so-vim-ws-internal.telcoItaly.it.crt` and then restart the service `systemctl restart nginx`

. Chech the application using this https://scopriofferta.telcoItaly.it/login[URL]

NOTE: To check the status using `systemctl status nginx`. Remember to inform the client

==== F5 BIG-IP
. Connecto to F5 with `Common` partition
. Reach "System -> File Management -> SSL Certificate List" path +
image:imagesCreateCert/image14.png[image,width=701,height=314]
. Look for expiring certificate like in the screenshot below (*certificate_name*) check if it's actually close to the expiring date, than Click on import +
image:imagesCreateCert/image15.png[image,width=759,height=170]
. Put the key and an id name for the new certificate (ex: vastv.cc.telcoItaly.it_03_12_20) +
image:imagesCreateCert/image16.png[image,width=705,height=389]
. At the end click Import:
. Click again on the newly created certificate 
. Upload `.crt` file, the new expire date should be shown
. Click "Local Traffic -> Profiles -> SSL Client"
. Look for the certificate that needs update 

WARNING: Watch out for the partition, it's different for every certificate

image:imagesCreateCert/image17.png[image,width=711,height=308]

[start=9]
. Change the highlighted fields in the screenshot with the new certificate. Delete the old one. Click on Update lower left:
image:imagesCreateCert/image18.png[image,width=710,height=350]
. Once finished, remember to sync the F5 +
image:imagesCreateCert/image19.png[image,width=710,height=306]

IMPORTANT: Certification update (private key+certificate+chain) has to be done simultaneously on F5 and Imperva, when the certificate is Public CA.

?? For some certificates we will need to add a double bundle in f5, the procedure is below

<<<

==== Linux Server

. Load the certificate on the server. 
. Find previous certificates path `find / -name <certName>*` or `find / -name *.crt*`
. Make `<today_date>_rch` folder and put the old certificates
. Move the new certificates
. If it's docker
  * The file owner must be `jsyssrv` run: `chown jsyssrv:jsyssrv fdcgw.telcoItaly.it.key`
  * Restart the container `[jsyssrv@mi5fdsx006 ~]$ docker service update --force fdcgw_kong`
  * The command *must* be launched on one machine only, docker will restart the other one. 
  ** > 20230518 I don't know which one. I tested it today from 6 and 4 and they restarted itself only
. Otherwise
  * owners must be `root:root` run: `chown root:root <filename>`
  * Restart `nginx` service with: `/etc/init.d/nginx restart` or look in history for the right command: `grep restart ~/.bash_history`

// We can script this!

<<<

==== Windows Server

. Connect to the host, or the bridge machine to connect to the host, through Remote Desktop Connection from EAG. 
. Right click the IP left column
. Select "Properties" -> "Local Resources" -> "Redirect options" 
. Flag "Drives" 
. Click OK
. Connect to the host, Right click the IP from the left column
. Click on "Reconnect server"
. Load the certificate on the server
. Run IIS "Internet Information Service" 
. Select hostname from left window "Server Certificates"
. Import `.pfx` certificate
. Locally save with "Export" button
. Move the old certificate into the folder `C:\Certificati\certificate_old`
. Click on "Sites" from the left list
. Select the site correspoding to the certificate
. Inside actions, on the right click "Edit Site" -> "Binding" -> "Edit" 
. Inside "SSL Certificate" click the new certificate
. Click OK
. Click top left "Host" 
. Click top right "Manager Server" 
. Click "restart".

> for the new machines CA root and Intermediate CA may be needed

// A script would be better

==== MMC install 

. Open console 
. From windows serach
. "mmc" +
. image:imagesCreateCert/image20.png[image,width=558,height=460]
. image:imagesCreateCert/image21.png[image,width=558,height=460]
. image:imagesCreateCert/image22.png[image,width=558,height=460]
. Import certificates +
image:imagesCreateCert/image23.png[image,width=558,height=456]
. Restart IIS +
image:imagesCreateCert/image24.png[image,width=558,height=460]

==== Custom step for report.apptitc.telcoItaly.it certificate on OSQ282v

.This procedure is needed only in OSQ282v yearly certificate renewal process.
. Install the new certificate on BIG-IP and WAF
. Connect to `osq282v` through Remote Desktop Connection from EAG. 
. Click the `.pfx` file, select "Local Machine", next a few times
. Select "Automatically select the certificate store based on the type of certificate

NOTE: Certificate is located in Certificates (Local Computer) Personal > Certificates

[start=5]
. Open the Report Server Configuration Manager
. Choose "Microsoft Report BI Report Server"
. Click connect
. Click "Web Service URL" from left menu
. Select the dropdown menu "HTTPS Certificate" than select the report.apptitc.telcoItaly.it
. Now Apply is clicable. Click Apply

.Sample result
image:imagesCreateCert/image26.png[image,width=279,height=230]

Verify at https://report.apptitc.telcoItaly.it/ReportServer[URL]

.Expected output
image:imagesCreateCert/image27.png[image,width=279,height=230]

<<<

=== Service Request with WAF Team

IMPORTANT: This procedure is necessary when updating a certificate together with the WAF team

 > To check whether the service comes under Bridge or TRP Mode

* Click on the https://oneitsm-dwp.onbmc.com/[link] and it will autologin using telcoItaly credentials

* From the Menu `Browse Categories` -> `Technology_VOIS` -> `Cyber Security` and follow the steps as per screenshots:

image:images/serviceWAF1.png[image,width=558,height=460]

image:images/serviceWAF2.png[image,width=558,height=460]

 > To update the certificate in WAF

* Follow the same procedure as mentioned above screenshot but change the description in tab

image:images/serviceWAF3.png[image,width=558,height=460]

<<<

== VMWare

.VMWare from EAG
|===
|Description |IP 

|vRealize Log Insight |https://10.128.123.31/
|Network Insight |https://10.128.123.55/
|NSX vSphere |https://10.128.123.9/
|===

=== Create the IPSET in vSPhere

.Ip Sets work like the object-groups created in the ASA FW

NOTE: This is configured for services that are available on the internet such as MINISITI - VOLA - AWS 

* From the Menu `Network and Security` -> `Groups and tags` -> `IP Sets`
* Create a new `IP Set`. Using the name given or previously chosen. Example: AWSvola
* Add the IPs needed in the set and press `save`

=== Add the IPSET in the rules to have data flux

* Go inside `Network and Security` -> `Firewall` -> Search the machine or Rule (in this case osx263v)
* If there is none under that name with the needed IPs then Create one in `Add Rule`
* Be aware of creating the Rule in the corresponding Section
* Give the new Rule a name
* Select the `Object Type` -> in this case the `Virtual Machine` -> osx263v as source
* Add the destination machine in this case AWSvola, after this specify the Service
in case there is no Service set as the one you need -> add a new one, specifying:
. Name (XXXX)
. Layer (in this case Layer3)
. Protocol (TCP or UDP)
. Port number (443)

* Press Publish

<<<

== Zabbix

.Zabbix devices
|===
|DNS |IP | Description

|MI5FDSX011 |10.128.123.93 |Zabbix DB server 1
|MI5FDSX012 |10.128.123.94 |Zabbix DB server 2
|MI5FDSX013 |10.128.123.95 |Zabbix DB Backup
|MI5FDSX014 |10.128.123.97 |Zabbix Engine / FrontEnd 1
|MI5FDSX015 |10.128.123.98 |Zabbix Engine / FrontEnd 2
|===

=== To dismiss Certificates in Zabbix

* When you receive a request from telcoItaly, for info in one or more Certificates
* Go inside the inventory:
`Registries` -> `Certificates` -> type the name an search for it -> you get the info needed
* Go to F5 (PRO or PRE) -> `Local Traffic` -> `Network Map` inside search for the correspondent service:
  * With the name of the certificate do an nslookup to have the IP determine if it is private or public. Example:  
  `nslookup vas.cc.telcoItaly.it`
  * If it is public from the firewall run `show nat | i <publicIP>` 
  * With the IP go to F5 and search for it in the Virtual Server List or in Network Map type
* If you have to dismiss one or more Certificates:  
`Registries` -> `Certificates` -> type the name an search for it
* Once that done change the Expire Date, X date in a thousand years and the SAN, servizio dismesso

=== Proactive Monitoring FastDelivery Network

.Open https://10.128.123.100/index.php[Zabbix]
image::images/zabix1.png[image,width=596,height=228]

.Go to Tab Problems, where will be showed All Devices, in Fast Delivery:
image::images/zabix2.png[image,width=596,height=228]

.Then apply the filter in the Tab on the right: 
image::images/zabix3.png[image,width=596,height=228]

.Now you can see alarms for all the server in charge in VF FastDelivery.
* Refer to only these alarms:
** Free disk space.
** High Memory Utilization.
** Disk space is very low
** Any information related to server: Big-IP Production MIVLB515.private.it MIVLB514.private.it
* After performing any checks on Big-IP o other Network device, please use this template to advise our colleagues from Application side.

<<<

== Decommissioning

=== Flag them as decommissioned on inventory

. https://10.132.181.116/home.phpp[inventory]
. click "Edit"
. Top right at the window there's a pen and a recycle bin. Click the Pen
. 2nd column, 6th option "Virtual Device Status", select Dismissed 
. Bottom right of this small window press "Save"

=== Fetch the info
. Identify project and devices from inventory
. Log into F5 PRE/PRO into Local Traffic -> Network Map
. Type the device names and fetch:
* DNS namings
* Virtual IP address
* Virtual Servers names
. Log into Firewall:
* `change context DMZ`
** `show nat | include <Virtual IP address>` 
** Fetch the public IP and remove it
** `show access-list | i <10.129.x.x>`
** Identify and remove all of them
** If they can't be removed check by ACL's line and get the object-group: `show access-list | i line <number>` (You can use the IP block section to remove a single IP from the object-group)
* `change context FRONTEND` 
** `show access-list | i <10.129.x.x>`
** Identify and remove all of them
** If they can't be removed check by ACL's line and get the object-group: `show access-list | i line <number>` (You can use the IP block section to remove a single IP from the object-group)
* `change context BACKEND` 
** `show access-list | i <10.129.x.x>`
** Identify and remove all of them
** If they can't be removed check by ACL's line and get the object-group: `show access-list | i line <number>` (You can use the IP block section to remove a single IP from the object-group)

=== Execute the changes
. On BIG-IP F5: 
* Set Virtual Server status as offline, black icon.
* Set Nodes status as offline, black icon. 

NOTE: Everything on the device must be black in order for Zabbix to stop monitoring it

[start=2]
. On excel: Striketrough the IPs and devices names in the https://telcoItaly-my.sharepoint.com/:x:/r/personal/gabriele_saronni_telcoItaly_com/Documents/telcoItaly_elTeamLoco/private_Buccinasco.xlsx?d=w5a7fd9de87ae4952acfab7e3fc4b646f&csf=1&web=1&e=u4E9Yy[IP table]
* Track the new freely available Public IPs, 91.80.46.x in the Tab and comment what they were used for, if there were any

[start=3]
. Log on vCenter MIVSX920 10.128.123.9, from chrome EAG
. Find the devices and shut them down. Keep them offline one week and than delete them
. Send an e-mail to roberta.geranio@telcoItaly.com, elizabeth.spezzano2@consultant.telcoItalyomnitel.it, davide.desalve@telcoItaly.com, stefania.sallusti@telcoItaly.com, with roberto.di-martino@consultant.telcoItalyomnitel.it, fabianamaria.basso@telcoItaly.com and gabriele.saronni@telcoItaly.com in Cc asking to remove them from backup and patching schedule
. If we don't own the DNS, please point them to the https://telcoItaly.sharepoint.com/sites/V-DNA?xsdata=MDV8MDJ8Z2FicmllbGUuc2Fyb25uaUB2b2RhZm9uZS5jb218Yjc4NTYxY2UxODgwNGI2NzI3NTMwOGRjZDNjMGRhNTF8NjgyODNmM2I4NDg3NGM4NmFkYjNhNTIyOGYxOGI4OTN8MHwwfDYzODYxODA3MjUwNDI2NzA0NXxVbmtub3dufFRXRnBiR1pzYjNkOGV5SldJam9pTUM0d0xqQXdNREFpTENKUUlqb2lWMmx1TXpJaUxDSkJUaUk2SWsxaGFXd2lMQ0pYVkNJNk1uMD18MHx8fA%3d%3d&sdata=NHU4TzAxYzRyTHo1enJTSVBtbU43MGcxMG5BeEFyRmpvazZ5MEVCam5Idz0%3d#/[telcoItaly.it DNS] team

=== Monitoring

. send an e-mail to davide.dasaro@telcoItaly.com, dl_vasfdops@telcoItaly.com  with roberto.di-martino@consultant.telcoItalyomnitel.it, fabianamaria.basso@telcoItaly.com and gabriele.saronni@telcoItaly.com in Cc asking to remove them from monitoring

<<<

== Anexes 

=== Procedure Examples

==== CM for ACL 

Mail in inbox: -> Re: 503024 Implementation of AWSLayer to IPLAN (Ironcloud Italy)

```
Ciao  Monica
In allegato una communication matrix che mi hanno spedito per il Progetto Ironcloud da implementare su IT_CSP_TRANSIT (RT 34419:13119 both IM & EX),

Ho aperto a IP Design il per il 503025 controllo del routing.
Non necessita di NAT 
```

IMPORTANT: If NAT is needed go to the ASA section regarding the actions 


.CM example
image::images/exampleCM.png[image,width=596,height=228]

.Once checked where the VRF arrives inside the Network Scheme, go to check the first routers `ASR 9K` and the `Nexus 5K`
```Cisco
RP/0/RSP0/CPU0:MIVMX900#sh rpl prefix-set | i IT_CSP_TRANSIT
Wed Oct  5 15:04:46.511 CEST
prefix-set pfx_IT_CSP_TRANSIT_toPE
prefix-set pfx_IT_CSP_TRANSIT_fromPE

Cisco Nexus 5000 
MIVMX904# sh ip prefix-list ?
  <CR>
  >                      Redirect it to a file
  >>                     Redirect it to a file in append mode
  WORD                   Name of prefix-list (Max Size 63)
  static-DSL_DATA        Known prefix-list name
  static-EITO_PROD       Known prefix-list name
  static-ITDCC           Known prefix-list name
  static-IT_CSP_TRANSIT  Known prefix-list name
  static-MGMT            Known prefix-list name
  static-SERVICE_CTP     Known prefix-list name
  static-TRUSTED_S2S     Known prefix-list name
  static-UNTRUSTED_U2S   Known prefix-list name
  |                      Pipe command output to filter

MIVMX904#sh ip prefix-list static-IT_CSP_TRANSIT
ip prefix-list static-IT_CSP_TRANSIT: 2 entries
   seq 5 permit 10.129.160.0/20
   seq 10 permit 10.128.128.0/22
```
* As seen before, the prefix are configured. Follow the procedure for each of them in the corresponding section in the ASR 9000 and Nexus 5000
* Go to the `MIVFX900-1` (firewall) and add in each context the new route -> this might depend on the route you are pointing. This hop goes from IT_CSP_TRANSIT up to DMZ

.In case you need to add routes inside ASA contexts
```Cisco
MIVFX900-1/MGMT/pri/act# ch co B
MIVFX900-1/BACKEND/pri/act# sh route | i 100.66.182.128
S        100.66.182.128 255.255.255.128 [1/0] via 192.168.28.1, IT_CSP_TRANSIT
```

.The service comes from 192.168.28.1 (IT_CSP_TRANSIT). That route is added to the context  
```Cisco
MIVFX900-1/BACKEND/pri/act# conf t
MIVFX900-1/BACKEND/pri/act(config)# route IT_CSP_TRANSIT NEEDED IP + SUBNET MASK + ROUTE 
MIVFX900-1/BACKEND/pri/act(config)# wr
```

.The same procedure is added in each context, addig the corresponding route in the prior command
```Cisco
MIVFX900-1/BACKEND/pri/act# sh route
MIVFX900-1/BACKEND/pri/act# sh route | i FRONT
S-       0.0.0.0 0.0.0.0 [1/0] via 192.168.65.1, FRONT-BACK
MIVFX900-1/BACKEND/pri/act(config)# ch c F
MIVFX900-1/FRONTEND/pri/act(config)#
MIVFX900-1/FRONTEND/pri/act# sh run | i route
route DMZ-FRONT 0.0.0.0 0.0.0.0 192.168.64.1 1
route FRONT-BACK 10.0.0.0 255.0.0.0 192.168.65.3 1
MIVFX900-1/FRONTEND/pri/act# conf t
MIVFX900-1/FRONTEND/pri/act(config)# route FRONT-BACK 139.47.176.48 255.255.255.240 192.168.65.3
MIVFX900-1/DMZ/pri/act(config)# route DMZ-FRONT 139.47.176.48 255.255.255.240 192.168.64.
```

<<< 

== SysAdmin Info: System administrator notes and configurations
== Commands 
=== Linux Commands 

https://www.die.net/[Bash Manual]  
https://www.gnu.org/software/bash/manual/bash.html[Official Book]

[cols="10%,90%"]
|===
|Manual |Syntax

.2+.^|https://linux.die.net/man/1/find[find] 
|find [-H] [-L] [-P] [-D debugopts] [-Olevel] [path...] [expression] 
m|find / -name *.crt

.2+.^|https://linux.die.net/man/8/debugfs[debugfs] 
|debugfs [ -Vwci ] [ -b blocksize ] [ -s superblock ] [ -f cmd_file ] [ -R request ] [ -d data_source_device ] [ device ] 
m|debugfs /dev/hda13

.2+.^|https://linux.die.net/man/1/df[df] 
|df [OPTION]... [FILE]... 
m|df -h

.2+.^|https://linux.die.net/man/1/mv[mv] 
|mv [OPTION]... SOURCE... DIRECTORY 
|

.2+.^|https://linux.die.net/man/1/cp[cp] 
|cp [OPTION]... [-T] SOURCE DEST 
|

.2+.^|https://linux.die.net/man/1/scp[scp] 
|scp [[user@]host1:]file1 ... [[user@]host2:]file2 
m|scp oss231:alpha.txt /home/ansysad

.2+.^|https://linux.die.net/man/1/ssh[ssh] 
|ssh [user@]host1 m|ssh oss231v

.2+.^|https://linux.die.net/man/1/grep[grep] 
|grep [OPTIONS] PATTERN [FILE...] 
|

.2+.^|https://linux.die.net/man/8/userdel[userdel] 
|userdel [options] [LOGIN] 
|

.2+.^|https://linux.die.net/man/1/unzip[unzip] 
|unzip [-Z] [-cflptTuvz[abjnoqsCDKLMUVWX$/:^]] file[.zip] [file(s) ...] [-x xfile(s) ...] [-d exdir] 
m|unzip file.zip

.2+.^|https://linux.die.net/man/5/passwd[passwd] 
|passwd [-k] [-l] [-u [-f]] [-d] [-e] [-n mindays] [-x maxdays] [-w warndays] [-i inactivedays] [-S] [--stdin] [username] 
|passwd [options] [LOGIN]

.2+.^|https://linux.die.net/man/1/gunzip[gunzip] 
|gzip [ -acdfhlLnNrtvV19 ] [-S suffix] [ name ... ] 
|

|===

TIP: Get needed info on commands using `--help`, `-h` or `man` cmd

<<<

==== SunOS Commands 

https://docs.oracle.com/cd/E19641-01/802-1930-1M/802-1930-1M.pdf[SunOS Manual]

===== Diagnostic Commands

[cols="50%,25,25%"]
|===
|Command |Description |Impact

|`zfs list`
|Lists ZFS filesystems, volumes, and snapshots
|Show only - displays filesystem information

|`zfs list -o name,used,avail,refer,mountpoint,quota`
|List ZFS datasets with specific properties
|Show only - displays detailed filesystem information

|`zfs list -t snapshot`
|List all ZFS snapshots
|Show only - displays snapshot information

|`zfs list -o name,used -s used`
|List ZFS datasets sorted by space usage
|Show only - helps identify large space consumers

|`zfs list -r -o name,used,refer,compressratio`
|List ZFS datasets with compression details
|Show only - shows space efficiency

|`beadm list`
|List boot environments
|Show only - displays bootable system snapshots

|`zpool list`
|Display zpool statistics
|Show only - shows pool size and utilization

|`zpool status rpool`
|Display detailed zpool status
|Show only - shows health and configuration

|`du -hs /*`
|Display disk usage by top-level directories
|Show only - helps identify large directories

|`df -h`
|Display filesystem space usage
|Show only - shows mounted filesystem space
|===

<<<

===== Modification Commands - Use With Caution

[cols="30%,35,35%"]
|===
|Command |Description |Impact

|`zfs destroy dataset_name`
|Remove a ZFS dataset
|*Potentially destructive* - permanently deletes the specified dataset

|`zfs destroy -r dataset_name`
|Recursively remove a ZFS dataset
|*Potentially destructive* - removes dataset and all descendants

|`zfs set quota=size dataset_name`
|Set a space limit on a dataset
|Low risk - limits future growth but doesn't delete data

|`zfs destroy snapshot_name`
|Remove a snapshot
|Low risk if snapshot isn't in use - frees snapshot space

|`zoneadm -z zonename reboot`
|Reboot a zone
|*Causes downtime* - interrupts all services in the zone

|`beadm create new_be`
|Create a new boot environment
|Low risk - creates a bootable system snapshot

|`beadm activate be_name`
|Set the default BE for next boot
|*May affect next boot* - changes which system is loaded at startup

|`beadm destroy be_name`
|Delete a boot environment
|*Potentially destructive* - removes a bootable system snapshot

|`zpool upgrade pool_name`
|Upgrade ZFS pool version
|*May affect compatibility* - pool can't be imported on older systems after upgrade
|===

<<<

===== Safe Space Recovery Commands for This System

[cols="50%,25,25%"]
|===
|Command |Description |Impact

|`zfs set quota=300G rpool/zone/oss213v`
|Set quota on oss213v zone
|Safe - prevents zone from consuming more space

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-0`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-1`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-2`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-3`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-4`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-5`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-6`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-7`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-8`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment

|`zfs destroy -r rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-9`
|Remove unmounted ZBE
|Safe if not mounted - removes old boot environment
|===

<<<

===== DANGER - High-Risk Commands

[cols="60%,20,20%"]
|===
|Command |Description |Impact

|`zfs destroy rpool/zone/oss213v/oss213v/rpool/ROOT/zbe-10`
|Remove the active ZBE
|*EXTREMELY DESTRUCTIVE* - will crash the zone and cause data loss

|`zfs destroy -r rpool/zone/oss213v`
|Remove entire zone filesystem
|*EXTREMELY DESTRUCTIVE* - deletes entire zone and all data
|===
<<<

=== Windows Comands 

https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/?view=powershell-7.3[Powershell Manual]

[cols="15%,90%"]
|===
|Manual |Syntax 

.2+.^|https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/route_ws2008[route] 
|route [/f] [/p] [<command> [<destination>] [mask <netmask>] [<gateway>] [metric <metric>]] [if <interface>]] 
m|route add 192.168.10.0 mask 255.255.255.0 192.168.1.1

.2+.^|https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771865(v=ws.11)[Net User] 
|net user [<UserName> {<Password> \ *} [<Options>]] [/domain] 
m|net user username password /add

.2+.^|https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-childitem?view=powershell-7.3[Get-ChildItem] 
|Get-ChildItem [[-Path] <string[]>] [[-Filter] <string>] [-Include <string[]>] [-Exclude <string[]>] [-Recurse] [-Depth <uint>] [-Force] [-Name] [<CommonParameters>]
m|Get-ChildItem -Path "C:\YourFolderPath"

.2+.^|https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/copy-item?view=powershell-7.1[Copy-Item]
|Copy-Item [-Path] <string[]> [-Destination] <string> [-Container] [-Force] [-Recurse] [-PassThru] [-Filter <string>] [-Include <string[]>] [-Exclude <string[]>] [-Credential <pscredential>] [-WhatIf] [-Confirm] [<CommonParameters>]
m|Copy-Item -Path "C:\Source\File.txt" -Destination "D:\Destination"

.2+.^|https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-process?view=powershell-7.1[Get-Process]
|Get-Process [[-Name] <string[]>] [-Id <int[]>] [-FileVersionInfo] [-Module] [-InputObject <Process[]>] [<CommonParameters>]
m|Get-Process winword, explorer \| Format-List *

.2+.^|https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-service?view=powershell-7.1[Get-Service]
|Get-Service [[-Name] <string[]>] [-RequiredServices] [-DependentServices] [-ComputerName <string[]>] [-Exclude <string[]>] [-Include <string[]>] [<CommonParameters>]
m|Get-Service -Name "win*" -Exclude "WinRM"

.2+.^|https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/start-service?view=powershell-7.1[Start-Service]
|Start-Service [-Name] <string[]> [-DisplayName <string[]>] [-InputObject <System.ServiceProcess.ServiceController[]>] [-PassThru] [-Verbose] [-WhatIf] [-Confirm] [<CommonParameters>]
m|Start-Service -Name Quartz

.2+.^|https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/stop-service?view=powershell-7.1[Stop-Service]
|Stop-Service [-Name] <string[]> [-DisplayName <string[]>] [-InputObject <System.ServiceProcess.ServiceController[]>] [-PassThru] [-Verbose] [-WhatIf] [-Confirm] [<CommonParameters>]
m|Stop-Service -Name Quartz

|===

TIP: You can look at all aliases with `alias` or with a specific command like: +
Get needed info on commands using `Get-Help <cmd>`

```powershell
alias ls

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Alias           ls -> Get-ChildItem
```

==== vCenter Snippets

```powershell
Connect-VIServer -Server 10.113.124.11 -User root -Password YouWish -Force
New-VMHostAccount -Id "VCentConnect" -Password "GuessIT!" -Description "SomeDescription"
New-VIPermission -Entity (Get-Folder ha-folder-root) -Principal "VCentConnect" -Role Admin
Get-VIPermission

Get-VIAccount
Get-VIRole
Get-VIPermission

Role                      Principal       Propagate IsGroup
----                      ---------       --------- -------
Admin                     vpxuser         True      False
Admin                     dcui            True      False
Admin                     root            True      False

New-VMHostAccount -Id "VCentConnect" -Password "GuessIT!" -Description "SomeDescription"
New-VIPermission -Entity (Get-Folder ha-folder-root) -Principal "VCentConnect" -Role Admin
#Set-VIPermission -Entity (Get-Folder ha-folder-root) -Principal "VCentConnect" -Role Admin

Disconnect-VIServer -Server 10.113.124.11 -Confirm:$false
```

<<<

== Remote Shell Login
.itmi3pans001
* Become ansysad: `sudo su - ansysad`
* `ssh <DNS or IPaddress>`

NOTE: As of 20230523 all machines should be connected to Ansible

.gminnms117
* `ssh -T -o StrictHostKeyChecking=no <IPaddress> 'cmd <neededCommand>'`
* `ssh -T -o StrictHostKeyChecking=no <IPaddress> 'powershell <neededCommand>'`
* `sftp <IPaddress>`

== RDP login

> If you're lucky you can access it locally from telcoItaly laptop, from run dialog (win+r) and type `mstsc`

* Log into EAG and open Remote Desktop Connection Manager or MobaXterm
** Create a new connection if necessary
* RDP to the device with needed domain credentials

TIP: Request for MobaXterm access to make the workflow faster

== Allow a Device to be Reached by Remote Shell

.Execute <<RDP login>>
. Open Server Manager 
. Go to `Tools`
. `Computer Management`
. Go to `Local Users and Groups` 
. Search the user sys_kpi
. Inside the `Properties` in members
. `Add`
. Select the location the server 
. Add the Administrators group
. Check inside `ProgramData` 

NOTE: inside `C:` remember to flag show hidden folders

[start=11]
. Inside the ssh folder right click `administrators_authorized_keys` and select `Properties`
. Choose `Security` tab 
. `Advanced`
. Click `Change option`
. Select the machines as location
. Add the group Administrators
. Check the connection

NOTE: If it doesn't work, check inside `Services`, if the ssh application is running you will have to request open the port

// A video of it would be nice and more straighforward
// What about CLI version of it?

<<<

== Gather Rilascio Files 
=== RDP version

TIP: From file explorer powershell can be invoked with `shit + right click`

. Log into EAG
. Open Remote Desktop Connection Manager or MobaXterm
.. Remote Desktop Connection
... If there's no connection: Create settings `File` > `New`
... Create connection to `10.129.175.32` aka `osq001v`
... Go to `Properties` > `Local Resources`
... Unflag `Inherit from parent`
... Flag `Drives` (Make sure all drives are flagged)
. Inside `Properties`
.. `Remote Desktop Settings`: Lets you decide screensize
.. `Logon Credentials`:  add your credentials zz + vpnpassword

.Inside the machine
* The "rilascio" files are inside `D:\FTPRoot\WAPPORTAL\ftptest`
* Your PC should be reachable from `Y:` or `V:` network shared drive. `:\Users\zz<youruser>\` 
* From powershell run: `Copy-Item -Path D:\FTPRoot\WAPPORTAL\ftptest\<nameOfTheFolder> -Destination Y:\Users\zz<yourUser>\Downloads -Recurse`

CAUTION: Most of the times your personal files aren't reachable unless clicked from File Explorer


=== Terminal version

.From gminnms117
* From pans log in `gminnms117`
* Log as `ansysad` then `sudo su - sys_kpi`

* With this user `sftp` into `10.129.175.32` aka osq001v usually
** Example:
*** `sftp://ftptest@10.129.175.32/RILASCI_PRO_DONATION/DIST-Argo-2022-12-15-S17390-Argo_Update`
*** `sftp> get /D/FTPRoot/WAPPORTAL/ftptest/RILASCI_PRO_DONATION/DIST-Argo-2022-12-15-S17390-Argo_Update/*zip`
* Return `ansysad` 
* move the retrieved file to ansysad home folder: `sudo mv /home/sys_kpi/*zip /home/ansysad` 
* Go back to itmi3pans001
* Get the file to pans folder: `scp gminnms117:Filename.zip .`

// Ansible could help

<<<

== User Management 
=== Windows 

.Create
* Create user `ssh -T -o StrictHostKeyChecking=no X.X.X.X 'cmd /c net user /create <userName>'`
* net user <username> <password> /add

.Delete
* Check if user exists `ssh -T -o StrictHostKeyChecking=no X.X.X.X 'cmd /c net user <userName>'`
* Delete user `ssh -T -o StrictHostKeyChecking=no X.X.X.X 'cmd /c net user /delete <userName>'`

// Ansible would be more straightforward

Check RDP Users: `net localgroup "Remote Desktop Users"`
Add RDP Users: `net localgroup "Remote Desktop Users" /add <username>`

=== Linux 

==== Create and delete

.Create as root
```bash
useradd -m -c "Added by Sysadmin" -g users $user
passwd $user
chage --mindays 1 $user 
chage --warndays 5 $user
chage --maxdays 90 $user
```

// Ansible would be more straightforward

.Delete as root
* Check if user exists `grep -c userName /etc/passwd`
* Delete user `userdel userName`

==== Reset and unblock

.As root
* Check if user exists: `grep -i userName /etc/passwd`
* Check user status: `passwd -s userName`
** Is it blocked?: `passwd -u userName`
* Reset password: `passwd userName`

- `-s`: This command displays information about the user account
- `-u`: It re-enables the account if it has been previously locked due to excessive login failures or other reasons.

==== Expiracy Date 

.As root for Suse and Unix Systems
* To change the date to never expire: `chage -M -1 userName` or `chage -I -1 -m 0 -M 99999 -E -1 userName`
** To check the status inside SunOS: `chage -l userName` or `grep -ni userName /etc/passwd`
** To check the status inside Suse: `id userName`

.As Root for SunOS
* To change the date to never expire: `passwd -x -1 userName`

NOTE: To check the RSA key `cat /home/sys_kpi/.ssh/authorized_keys`

// some level of automation would be nice, even macros could do

==== Application Users

.As root for RHEL
`chage -E -1 -m 0 -M 99999 -I -1 -W -1 userName`

* `-E -1:` Sets the account expiration date to "never."
* `-m 0`: Sets the minimum number of days between password changes to 0.
* `-M 99999`: Sets the maximum number of days between password changes to a very large number, effectively making it never expire.
* `-I -1`: Sets the inactive (locked) period to "never."
* `-W -1`: Sets the warning period to "never."

.As root for SunOS
`passwd -x -1 -N userName`

* `-x -1`: This part of the command sets the maximum number of days a password is valid to -1, effectively disabling password expiration.
* `-N`: This option is used to clear the password aging information for the specified user, which further ensures that there are no password expiration settings in place.

==== Restablish RSA keys for a user 
.Unblock the user as root 

* Generate RSA Keys
** Log in as the required user.
** Check if the `.ssh` folder exists. If not, create it using `mkdir .ssh`.
** Navigate into the `.ssh` folder.
** Generate the RSA key pair by running:
 ```
 ssh-keygen -t rsa -b 4096 -C "username@yourDomain.com"
 ```
** When prompted, choose the default location to save the key pair by pressing Enter.
** For the passphrase, leave it blank and press Enter.

* Add Public Key to Authorized Keys
** After generating the key pair, two files are created: `id_rsa` (private key) and `id_rsa.pub` (public key).
** Append the public key to the `authorized_keys` file using:
 ```
 cat id_rsa.pub >> authorized_keys
 ```

* Adjust Permissions
** Ensure correct permissions for security:
 ```
 chmod 700 ~/.ssh
 chmod 600 authorized_keys
 ```

IMPORTANT: Please reply to the request and send the private key in a separate email to the requester. 

== Add sys_kpi to gminnms117
* If it does not exist, create `sys_kpi` user and add it to `Administrator and remote desktop users` group
* Install `freeSSHd.exe` package with Admin user.
* Create the txt file name it `sys_kpi` and copy & paste the following key inside it:

```txt
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAIEA1Ee4hKw6NxsGOegq1Oflu2me1SCPe/gl5Lpjx8v142dXhX1MNOjgRqSNijJtfFK1fo2DcwF7EfaafZVPCgCa2ptDUzH7+BYYc6gkuCUV7F9CuHgSNOdxjVe44TSL7Gd3VDzL7IK6UCTEtwIrPhQyGQ5DqUOHT0R/c63WNVxrKDs= sys_kpi@gminnms117
```

* Copy the text file to the following location: `C:\Program Files (x86)\freeSSHd`
* Run freesshd management console from desktop icon
** Create `sys_kpi` user as shown in the figure:

image::imagesAll/sysadmin1.png[image,width=298,height=114]

** Click on `apply` and test the connection from gminnms117. 
** Run `ssh -T -o StrictHostKeyChecking = no IPserverwindows 'cmd / c net user'`
** If the key exchange does not work, restart `freesshd` service

.Workaround
* If the ssh command returns `//` without the machine name:
** Stop the freesshd service and set it manually
** Start the management console from the link on the desktop
** Start ssh from the server status tab 

image::imagesAll/sysadmin2.png[image,width=298,height=114]

<<< 

== Disk Space Activity

=== Windows GUI

. Get https://www.diskanalyzer.com/download[WizTree] portable
. Copy the zip into the needed device
. Attach screenshots to the mail

=== Commands Reference

.Unix means works on both RHEL and SunOS
[cols="11%,89%"]
|===
|OS |Command

|RHEL    m|du -h
|RHEL    m|du -h -d1 / \| sort -hr \| head -n 10
|SunOS   m|zfs list
|SunOS   m|zpool list
|SunOS   m|du -hs *`
|SunOS   m|du -hs * \| grep G
|SunOS   m|du -d 1 -k / \| sort -rn \| head -n 10
|SunOS   m|du -d 1 -ks / \| sort -rn \| head -n 10
|SunOS   m|du -h \| sort -r \| head -n 10
|SunOS   m|du -d 1 -k / \| awk '{size=$1/1000000; printf "%.2f MB\t%s\n", size, $2}' \| sort -rn \| head -n 10
|SunOS   m|du -d 1 -ks / \| awk '{size=$1/1000000; printf "%.2f MB\t%s\n", size, $2}' \| sort -rn \| head -n 10
|Unix    m|find / -type d -size +10G
|Unix    m|du -d1 --block-size=1G / \| awk '$1 > 10'
|Unix    m|du -h -d1 / \| sort -hr \| head -n 10
|Windows m|Get-ChildItem -Path C:\ -Directory -Recurse \| Where-Object { $_.Length -gt 10GB }
|Windows m|Get-ChildItem -Recurse \| sort -Descending length \| select -First 7
|Windows m|Get-ChildItem -Path C:\ -Directory -Recurse \| Where-Object { $_.Length -gt 10GB } | Remove-Item -Recurse -Force

|===

In case of a huge file you can look for the specific line from which they are needed: + `grep -in '2022/01' filename` or similar combinations. +
Usually around one year worth of logs, and use the following range: `sed -i '1,14091155d' filename` where 1 is the first line and 14091155 is the first match of the above `grep` command.

CAUTION: `Sed` will buffer the file. Be sure to have enough space before running it!

==== Crontab issues

First thing to do is to verify what's inside crontab: +

. Check first root's crontab: `crontab -l`
. Since it's usually empty you can check the specific user on the system: `crontab -l applicationUser`
** It can be erif, jboss, jsyssrv. The latter is the most frequent. If none ask which user has to be checked
. If you see on top of the output: "Warning - 'applicationUser' password has expired and needs to be changed"
.. You can look up <<User Management>> 
.. Once finished send an e-mail and ask if it's an application user that uses only rsa-keys to log and nobody uses User and Password login
.. Once received affirmative answer you can proceed with <<Application Users>> otherwise you'll have to do this again in 90 days. 
. Fetch the path, which statistically is `/app/applicationUser/logpath/logcleaner`
. Check if it has execution permissions: `ls -l /path/to/the/file`
** if not you can add them with `chmod +x /path/to/the/file`

==== ZFS pool fix

. Identify the global zone for the needed device. Inventory can help sometimes
. Check allocated storage, "quota": `zfs get quota,reservation rpool/zone/oss0xx`
. Check available space: `zpool list rpool` or whatever naming convention is chosen
. If there's space raise the quota: `zfs set quota=60G rpool/zone/oss0xx`
. Check actual status: `zfs get quota rpool/zone/oss0xx`
. Once the cleaning has been done please shrink it back: `zfs set quota=55G rpool/zone/oss0xx`

.Example:
```bash

oss164:{root}:/# df -h | grep 100
rpool/zone/oss059       55G    31G     0K   100%    /zone/oss059

oss164:{root}:/# zfs get quota,reservation rpool/zone/oss059
NAME               PROPERTY     VALUE   SOURCE
rpool/zone/oss059  quota        55G     local
rpool/zone/oss059  reservation  none    local

oss164:{root}:/# zpool list rpool
NAME   SIZE  ALLOC   FREE  CAP  HEALTH  ALTROOT
rpool  136G   120G  16.1G  88%  ONLINE  -

oss164:{root}:/# zfs set quota=60G rpool/zone/oss059

oss164:{root}:/# zfs get quota rpool/zone/oss059
NAME               PROPERTY  VALUE  SOURCE
rpool/zone/oss059  quota     60G    local

oss164:{root}:/# zfs list rpool/zone/oss059
NAME                USED  AVAIL  REFER  MOUNTPOINT
rpool/zone/oss059  55.0G  5.00G  30.6G  /zone/oss059

zfs set quota=55G rpool/zone/oss059

```

==== Infrastructure and Minicluster Machines 

[cols="20%,80%"]
|===
|Client | Example Machines 

.4+.^|Minicluster 
|mi5fds701mgt1 
|mi5fds702mgt1 
|mi5fds701mgt2 
|mi5fds702mgt2 

.2+.^|Infrastruttura 
|mi5fdsx005
|osx254v

|===

* All devices are accessible from the almighty `itmi3pans001`
* Minicluster needs: `oracle@mi5fds70*` the password can be found in inventory

TIP: I've already updated all the macros and with mobaXterm or RoyalTS you'll be able to login automatically. Please notify me

==== Legacy 

* Usually the folders are:
```
/u01/app/grid/diag/tnslsnr/mi5fds702db1/listener/alert
rm log_*

/u01/app/grid/diag/tnslsnr/mi5fds702db1/listener/trace
/u01/app/grid/diag/tnslsnr/mi5fds702db1/listener_scan_mgmt_scan1_net2/alert
rm log_*

/u01/app/grid/diag/tnslsnr/mi5fds702db1/listener_scan_mgmt_scan1_net2/trace
rm listener_scan_mgmt_scan1_net2_*

listener_scan_mgmt_scan3_net2/alert
rm log_*

/u01/app/grid/diag/tnslsnr/mi5fds702db1/listener_scan_mgmt_scan3_net2/trace
rm listener_scan_mgmt_scan3_net2_*

/app/oracle/diag/tnslsnr/mi5fdsx005/listener/trace
rm listener_*

```
* Look for `diag` directory and clear the `listener` logs
* In this case `cd /app/oracle/diag/tnslsnr/mi5fdsx005/listener/trace`
* Keep the original listener.log and deleted the older `listener_*`

// A stupid script should be made or something like `find /app/usrbck/iseusrbck/*gpg -mtime +370 -delete`

After retreiving the device situation you can send an email to the group owner matching the group name against the below table

<<< 

== Database 

=== Inventory

* Inventory device is gminnms116, 10.132.181.116
* Log into with https://www.oracle.com/database/sqldeveloper/technologies/download/[SQLDeveloper]

.Sample query
```
SELECT * FROM SESYS_USERS WHERE USERNAME = 'zzcks'

DELETE FROM SESYS_USERS WHERE USERNAME = 'zzponnusamyr'
```
commit = F11


<<<

==  ICMF Application Restart

In increasing order the used servers are osx356v, 57v, 58v, 59v, 60v, and 61v, will be restarted.

TIP: In case the process refuses to stop you can `ps aux | grep <name>` and `kill -9`

=== osx356v

IMPORTANT: Become icmf: `su icmf`

.Processes
[cols="10%,30%,20%"]
|===
|Process |Path |Command

|Registry 
.2+.^|`/app/icmf/icmf_common/bin-local` 
|`./registry.sh status`

|ICMFRR

|`./component.sh ICMFRR status`

|NPSMB01 |`/app/icmf/icmf_nps/bin-local` |`./component.sh NPSMb01 status`
|Mb01 |`/app/icmf/icmf/bin-local/` |`./component.sh Mb01 status`

|===

TIP: The keyword "status" from the above table can be replaced with "stop" and "start"

.Kill all snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./registry.sh stop
./component.sh ICMFRR stop
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMb01 stop
cd /app/icmf/icmf/bin-local/
./component.sh Mb01 stop
```

TIP: Killing help `ps aux | grep -e "Mb01" -e "NPSMb01"`

.Status snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./registry.sh status
./component.sh ICMFRR status
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMb01 status
cd /app/icmf/icmf/bin-local/
./component.sh Mb01 status
```

.Start snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./registry.sh start
./component.sh ICMFRR start
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMb01 start
cd /app/icmf/icmf/bin-local/
./component.sh Mb01 start
```

=== osx357v

IMPORTANT: Become icmf: `su icmf`

.Processes
[cols="10%,40%,40%"]
|===
|Process |Path |Command

|ICMFRR |`/app/icmf/icmf_common/bin-local` |`./component.sh ICMFRR status`
|NPSMb02 |`/app/icmf/icmf_nps/bin-local` |`./component.sh NPSMb02 status`
|Mb02 |`/app/icmf/icmf/bin-local` |`./component.sh Mb02 status`
|===

.Stop snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR stop
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMb02 stop
cd /app/icmf/icmf/bin-local/
./component.sh Mb02 stop
```

TIP: Killin help `ps aux | grep -e "Mb02" -e "NPSMb02"`

.Status snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR status
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMb02 status
cd /app/icmf/icmf/bin-local/
./component.sh Mb02 status
```

.Start snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR start
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMb02 start
cd /app/icmf/icmf/bin-local/
./component.sh Mb02 start
```

=== osx358v

IMPORTANT: Become icmf: `su icmf`

.Processes
[cols="10%,40%,40%"]
|===
|Process |Path |Command

|ICMFRR |`/app/icmf/icmf_common/bin-local` |`./component.sh ICMFRR status`
|NPSCn01 |`/app/icmf/icmf_nps/bin-local` |`./component.sh NPSCn01 status`
|PullCn01 |`/app/icmf/icmf/bin-local` |`./component.sh PullCn01 status`
|===

.Stop snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR stop
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSCn01 stop
cd /app/icmf/icmf/bin-local/
./component.sh PullCn01 stop
```

.Status snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR status
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSCn01 status
cd /app/icmf/icmf/bin-local/
./component.sh PullCn01 status
```

.Start snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR start
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSCn01 start
cd /app/icmf/icmf/bin-local/
./component.sh PullCn01 start
```

=== osx359v

IMPORTANT: Become icmf: `su icmf`

.Processes
[cols="10%,40%,40%"]
|===
|Process |Path |Command

|ICMFRR |`/app/icmf/icmf_common/bin-local` |`./component.sh ICMFRR status`
|NPSCn02 |`/app/icmf/icmf_nps/bin-local` |`./component.sh NPSCn02 status`
|PushCn03 |`/app/icmf/icmf/bin-local` |`./component.sh PushCn03 status`
|===

.Stop snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR stop
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSCn02 stop
cd /app/icmf/icmf/bin-local/
./component.sh PushCn03 stop
```

.Status snippet
```bash
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR status
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSCn02 status
cd /app/icmf/icmf/bin-local/
./component.sh PushCn03 status
```

.Start snippet
```bash
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR start
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSCn02 start
cd /app/icmf/icmf/bin-local/
./component.sh PushCn03 start
```

=== osx360v

IMPORTANT: Become icmf: `su icmf`

.Processes
[cols="20%,40%,40%"]
|===
|Process |Path |Command

|ICMFRR |`/app/icmf/icmf_common/bin-local` |`./component.sh ICMFRR status`

|NPSMemDB1a .2+.^|`/app/icmf/icmf_nps/bin-local` |`./component.sh NPSMemDB1a status`
|NPSPr01 |`./component.sh NPSPr01 status`

|PushMemDB1a .5+.^|`/app/icmf/icmf/bin-local` |`./component.sh PushMemDB1a status`
|PushPr01 |`./component.sh PushPr01 status`
|PushMemDB2b |`./component.sh PushMemDB2b status`
|PullMemDB1a |`./component.sh PullMemDB1a status`
|PullPr01 |`./component.sh PullPr01 status`
|===

.Stop snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR stop
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMemDB1a stop
./component.sh NPSPr01 stop
cd /app/icmf/icmf/bin-local/
./component.sh PushMemDB1a stop
./component.sh PushPr01 stop
./component.sh PushMemDB2b stop
./component.sh PullMemDB1a stop
./component.sh PullPr01 stop
```

.Status snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR status
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMemDB1a status
./component.sh NPSPr01 status
cd /app/icmf/icmf/bin-local/
./component.sh PushMemDB1a status
./component.sh PushPr01 status
./component.sh PushMemDB2b status
./component.sh PullMemDB1a status
./component.sh PullPr01 status
```

.Start snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR start
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMemDB1a start
./component.sh NPSPr01 start
cd /app/icmf/icmf/bin-local/
./component.sh PushMemDB1a start
./component.sh PushPr01 start
./component.sh PushMemDB2b start
./component.sh PullMemDB1a start
./component.sh PullPr01 start
```

=== osx361v

IMPORTANT: Become icmf: `su icmf`

.Processes
[cols="20%,40%,40%"]
|===
|Process |Path |Command

|ICMFRR |`/app/icmf/icmf_common/bin-local` |`./component.sh ICMFRR status`

|NPSMemDB1b .2+.^|`/app/icmf/icmf_nps/bin-local` |`./component.sh NPSMemDB1b status`
|NPSPr02 |`./component.sh NPSPr02 status`

|PushMemDB1b .5+.^|`/app/icmf/icmf/bin-local` |`./component.sh PushMemDB1b status`
|PullMemDB1b |`./component.sh PullMemDB1b status`
|PushMemDB2a |`./component.sh PushMemDB2a status`
|PushPr02 |`./component.sh PushPr02 status`
|PullPr02 |`./component.sh PullPr02 status`
|===

.Stop snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR stop
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMemDB1b stop
./component.sh NPSPr02 stop
cd /app/icmf/icmf/bin-local/
./component.sh PushMemDB1b stop
./component.sh PullMemDB1b stop
./component.sh PushMemDB2a stop
./component.sh PushPr02 stop
./component.sh PullPr02 stop
```

TIP: Killin help `ps aux | grep -e "Mb02" -e "NPSMb02"`

.Status snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR status
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMemDB1b status
./component.sh NPSPr02 status
cd /app/icmf/icmf/bin-local/
./component.sh PushMemDB2a status
./component.sh PushMemDB1b status
./component.sh PushPr02 status
./component.sh PullMemDB1b status
./component.sh PullPr02 status
```

.Start snippet
```bash
su icmf
cd /app/icmf/icmf_common/bin-local/
./component.sh ICMFRR start
cd /app/icmf/icmf_nps/bin-local/
./component.sh NPSMemDB1b start
./component.sh NPSPr02 start
cd /app/icmf/icmf/bin-local/
./component.sh PushMemDB2a start
./component.sh PushMemDB1b start
./component.sh PushPr02 start
./component.sh PullMemDB1b start
./component.sh PullPr02 start
```

> 20230705 I can make custom macro for the checks

// Script needed. Let's start from bash and move to ansible. 

<<<

== DWH Activity

[cols="17h,~"]
|===
|Reply |Machines 

|PRE |osq203v

|PROD a| 
* MI5FDSQ021
* MI5FDSQ022
|===

=== For the User Creation:

* Enter https://servicehelp.telcoItaly.com/[IUAM]

* Go to New Account Request and select for Competence Area `Cloud & OSS Operation` and platform `FastDelivery - Reply` as shown below:

image::imagesAll/userCreationforDWH1.png[image,width=596,height=228]

* Then select the profile, in profile list press `ODI` and for the user pick `Operativa and Operativa_STG` as shown in the image: 

image::imagesAll/userCreationforDWH2.png[image,width=596,height=228]

* The last step will be to select your Personal Account and give a motivation that will be `Fastdelivery Operations`

<<<

=== Setting up the ODI Connection

NOTE: This is a one time set up

==== ODI Studio

* Once inside the server open File Explorer and go to this path `C:\Oracle\Middleware\Oracle_home` press continue as administrator.
* Open ODI studio, Press `Connect to Repository`, it will prompt a tab called Repository Connection Information, 
** In some cases the ODI might ask to specify the folder, select Browse and follow this path `C:\Progarm Files\Java\jdk*` select the folder press OK, once the ODI is opening it will show a tab where you press NO.
* We will proceed to configure it with the following info, Press `Connect to work Repository` and follow:

.Oracle Data Integrator Connection

* Login Name -> identifies the connection, it can be called as you wish. 
* User -> zz<youruser> 
* Password -> Use the one assigned 

.Database Connection
 
* User -> `ODIPROD_ODI_REPO`
* Password -> Use the one given
* Driver List: `Oracle JDBC Driver`
* Driver Name: `oracle.jbdc.OracleDriver`
* URL: `jdbc:oracle:thin:@mi5fds7-scan:1521/ASCVI_SRV`
 
.Work Repository 

* Select the option Work Repository and press the search buttom then select the `WORKREP` option and press OK, it will prompt one last choice to store the info inside ODI press, select the second option `store password without secure wallet`

* Final result should be like the image below:

image::imagesAll/odiConnection.png[image,width=596,height=228]

<<<

==== Oracle SQL Developer

IMPORTANT: once you have added the correct info test the connection no more than once for each session

* Press the green cross to the left to create a new session, you will do this twice for `ascvi` and `dwhvi`: 
* Set the Name of the session as `ascvi`
** Username `dwhsvi` and insert psw given, select the option safe password.
** Hostname is `mi5fdsq7-scan.private.it`, port `1521`, and service name `ASCVI_SRV`
** Final result should be like the image below:

image::imagesAll/ascviSession.png[image,width=596,height=228]

* Set the Name of the session as `dwhvi`
** Username `dwhsvi` and insert psw given, select the option safe password.
** Hostname is `mi5fdsq7-scan.private.it`, port `1521`, and service name `DWHVI_SRV`
** Final result should be like the image below:

image::imagesAll/dwhviSession.png[image,width=596,height=228]

<<<

== Get_Users IUAM update monthly

This activity involves gminnms117 from `sys_kpi` user under the path `AccountReconciliation_GetUsers/AccountReconciliation`.  

TIP: `cd Acc <Tab>`

This script will log into all the devices that in inventory has "Ade" "Yes" flag and takes notes of the accounts inside. +
With the no option that log stays local in the machine, with the flag yes it's converted into a csv and pushed into IUAM machine.

It has to be done monthly by hand:

* You **cannot** put it at crontab 
* You **cannot** use `nohup` or `screen` or any hang option

It must be run the first friday of the month in order to get the month change in the output.

* If the first friday of the month is not the first day of the month

IMPORTANT: The script must be executed manually and the session must be kept logged on. All commands start from the `/home/sys_kpi/AccountReconciliation_GetUsers/AccountReconciliation` because `./Get_Users` script location

=== Test weekly friday

To test the situation use the following commands:

.You can use history to get the command: `ctrl+R no` should return the command
```bash
./GetUsers.sh  "Fast Delivery" "ade" "cron" "query/cron.sql" "no"
./GetUsers.sh  "SE SysAdmin" "ade" "cron" "query/cron.sql" "no"
```

NOTE: As 20230804 FastDelivery takes around 5m and SE SysAdmin takes 1h. + 
As 20230825 FastDelivery takes around 5m and SE SysAdmin takes 1h40m

Check the output:
```bash
ls -1 output/Fast_Delivery/cron/ade/yyyymmdd.HH/tmp
ls -1 output/SE_SysAdmin/cron/ade/yyyymmdd.HH/tmp
```

Send an email to: manager2@consultant.telcoItalyomnitel.it; colleague@consulences.com; colleague@telcoItaly.com; elizabeth.spezzano2@consultant.telcoItalyomnitel.it

With Cc: boss@consultant.telcoItalyomnitel.it; boss2@consulences.com; manager@consulences.com; gabriele.saronni@telcoItaly.com; fabiana@telcoItaly.com

The mail subject will be: https://weeknumber.com/[weeknumber] - Get_Users - TEST - ADE 

The mail body will be: +
Here FastDelivery anomalies: +
`ls -1 AccountReconciliation/output/Fast_Delivery/cron/ade/yyyymmdd.HH/tmp` +
Here SESysAdmin anomalies: +
`ls -1 AccountReconciliation/output/SE_SysAdmin/cron/ade/yyyymmdd.HH/tmp`

Now fetch the attachments, they need to be renamed as `csv` and downloaded:

.As sys_kpi from gminnms117
```bash
cp AccountReconciliation_GetUsers/output/Fast_Delivery/cron/ade/yyyymmdd.HH/result/systems.accounts yyyymmdd_FD.csv
cp AccountReconciliation_GetUsers/output/SE_SysAdmin/cron/ade/yyyymmdd.HH/result/systems.accounts yyyymmdd_SA.csv
```

> delete any `csv` leftover from previous runs

=== Production, every first friday of the month
To execute it

.You can use history to get the command: `ctrl+R yes` should return the command
```bash
./GetUsers.sh  "Fast Delivery" "ade" "cron" "query/cron.sql" "yes"
./GetUsers.sh  "SE SysAdmin" "ade" "cron" "query/cron.sql" "yes"
```

.Check the output:
```bash
ls AccountReconciliation/output/Fast_Delivery/cron/ade/yyyymmdd.HH/tmp
ls AccountReconciliation/output/SE_SysAdmin/cron/ade/yyyymmdd.HH/tmp
```

NOTE: As 20230804 FastDelivery keeps the same elapsed time while instead SysAdmin 40m

> The last output line should be an scplike output confirming the file has been pushed successfully

`Account-OS-SESysAdmin_ADE_yyyymm.csv                                                                                                                    100%  966KB 965.6KB/s   00:00`

==== Extra trimming

* FastDelivery: `sed -i '/connection/d' Account-OS-Fast_Delivery_ADE_202404.csv` (sed -i '/;connection/d' )
* SeSysAdmin: 
** `cd ~/AccountReconciliation_GetUsers/output/SE_SysAdmin/cron/ade/20240405.06/result`
** `sed -i '/Comando\|completato\|con\|per\|utente/d' system.accounts`
** `egrep -iwf ../../../../../../iuam_hosts.lst systems.accounts > Account-OS-SESysAdmin_ADE_202404.csv`
** `awk -F';' '{print $1}' system.accounts | sort -u | wc -l`

NOTE: As of 20240408 Fastdelivery has: 188 and SysAdmin 956 lines 

==== In case of erros:

* Destination folder: `ssh sysadmin_sftp@10.133.225.176 ls -l /ACFSdisk/iuam_ade`
* expected output: `/ACFSdisk/iuam_ade`

In case the file is not there: you need to upload them manually:

* Account-OS-Fast_Delivery_ADE_yyyymm.csv
* Account-OS-SESysAdmin_ADE_yyyymm.csv

if csv not present:

```bash
cd /home/sys_kpi/AccountReconciliation_GetUsers/output/SE_SysAdmin/cron/ade/yyyymmdd.hh/result

cp systems.accounts Account-OS-SESysAdmin_ADE_yyyymm.csv
scp Account-OS-SESysAdmin_ADE_yyyymm.csv sysadmin_sftp@10.133.225.176:/ACFSdisk/iuam_ade

cd /home/sys_kpi/AccountReconciliation_GetUsers/output/Fast_Delivery/cron/ade/yyyymmdd.hh/result

cp systems.accounts Account-OS-Fast_Delivery_ADE_yyyymm.csv
scp Account-OS-Fast_Delivery_ADE_yyyymm.csv sysadmin_sftp@10.133.225.176:/ACFSdisk/iuam_ade

ssh sysadmin_sftp@10.133.225.176 ls -l /ACFSdisk/iuam_ade
```

.Warn the team to run again the process
Send an e-mail to: DL-ServiceHelp@telcoItaly.com;
With Cc: boss2@consulences.com; manager@consulences.com

```

potete proseguire con la lavorazione:

ssh sysadmin_sftp@10.133.225.176 ls -l /ACFSdisk/iuam_ade
-rw-rw-rw- 1 sysadmin_sftp   sftp_ade        127669 Feb 23 17:59 Account-OS-Fast_Delivery_ADE_202402.csv
-rw-rw-rw- 1 sysadmin_sftp   sftp_ade        930697 Feb 23 17:58 Account-OS-SESysAdmin_ADE_202402.csv
```

<<<

== Periodic Process Restart

.Example request
```
Buongiorno,
per forzare il ripristino della connessione verso la coda oracle, 
si richiede di eseguire il restart con utenza "jsyssrv" del componente "logicmm" sui due nodi "oss245 e oss246".
Grazie
```

* Servers can be accessed from itmi3pans001, or using mobaXterm saved sessions
* log as the requested user, "jsyssrv"
* Run a `find / -name <indicated_service>*` to find service path. Usually something like `path_to_service/bin/`
* Verify service status with one of the following `./service.sh check` or `./service.sh status` 
** Check if the service has the following commands available; `./service.sh restart`, `./service.sh stop`, `./service.sh graceful-restart`
** You can run `./service.sh` without commands in order to discover possibilities

.If there's no stop command or it refuses to die
* Determine the PID (Process ID) using `ps aux | serviceName`
* Kill it: `kill -9 PID`
* Restart service `./service.sh start`
** Repeat the process in all the requested servers
* Reply to the request

<<<

=== Restore All Services On Servers
.Example request
```
Good Morning,
We have observed that since XXX yesterday ALL services on XXX servers have stopped working as if a kill of all processes was done.

Could you please provide an audit and turn all services back on?
Grazie
```
* Servers can be accessed from itmi3pans001, or using mobaXterm saved sessions
* Inside the path `/var/tmp/` check the owner of the script named `ossXXX_start_all.sh`
* Log as the requested user and run the script named `ossXXX_start_all.sh` 

=== Transaction manager

.Example request
```
Buongiorno,
a seguito di questo allarme vi chiedo di provvedere a fare il restart del transactionmanager del nodo oss245
Grazie
```

* Servers can be accessed from itmi3pans001, or using mobaXterm saved sessions
* The server is listed this time: oss245
** Beware that this is twin with oss246
* log as the requested user, in this case it's not told but it's `jsyssrv`
* The steps are the following

CAUTION: Log as `jsyssrv` from `ansysad` user. In case you log from moba sessions, type `exit` or ctrl+d to revert back to ansysad from root

```
sudo su - jsyssrv
cd /app/jsyssrv/jboss-as-7.1.1.Final/bin/
./transactionmanager.sh stop
./transactionmanager.sh start
```

if you encounter the following:
```
jsyssrv@oss246:/app/jsyssrv/jboss-as-7.1.1.Final/bin# ./transactionmanager.sh start

[INFO] - Checking transactionmanager status
[INFO] - PID file trovato (6002) - Verifico se c'Ã¨ un processo di transactionmanager attivo
[WARN] - Questa istanza di transactionmanager sembra essere ancora attiva
[WARN] - Aspetta ancora qualche secondo prima di tentare un riavvio
[ALERT] - Se invece sei proprio sicuro di cosa stai facendo, esegui: kill -9 6002 6045
```

Run the suggested command: `kill -9 6002 6045` which is different every time

> It is most likely that after confirming the restart on oss245 another mail will follow asking for the same activity on oss246

<<<

=== Memobarring

* Servers can be accessed from itmi3pans001, or using mobaXterm saved sessions
** oss256
** oss257
** oss258
* become `su - memobarring`
* The path is: `/app/barringws/fsb/memobarring`
* Run `./barringws stop`
* Run `./barringws start`

<<<

=== King Kong FDCGW

.Example request
```
Ciao,

dopo il patching di questa mattina  il processo Kong risulta spento.
Potete forzare un update del servizio ?
Collegarsi su un nodo di docker ( mi5fdsx006 o mi5fdsx007 ) con l’utenza jsyssrv e dare il comando
docker service update fdcgw_kong
Se non funziona provate a eseguire questa procedura:
docker service scale fdcgw_kong=0
docker service scale fdcgw_kong=1
docker service scale fdcgw_kong=2

Nota:
Per verificare che sia tutto a posto  potete usare il comando: `docker service ls`

Dovrebbe mostrare 2 istanze di fdcgw_kong attive
```

* The server can be accessed from itmi3pans001, or using mobaXterm saved sessions
* Log into either of the asked ones but don't do the activity on both
* **Don't** use `docker service update fdcgw_kong`
* Run the other commands direcly one after the other
* Check with `docker service ls`

<<<

=== Restart Agent inside ODI Devices

.Example request
```
Ciao,
Venerdì scorso non ci siamo accorti che con il ripristino della MI5FDSQ021 non si è provveduto a riattivare l’agente ODI oraclediagent1.
Si chiede quindi di provvedere il prima possibile.
```

* Log inside the required server or servers from EAG 
* From Command Prompt go inside this path `C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain\bin`
* Run this command `startComponent.cmd OracleDIAgent1`
* You will be asked to insert a password regading the Node Manager Oracle ODI MI5FDODI01 and MI5FDODI02, stored inside the inventory

NOTE: Remember the agents are: OracleDIAgent1 - MI5FDSQ021 and OracleDIAgent2 - MI5FDSQ022

<<<

=== Restart ERIF LEGACY

.If you are not already, log in with the erif utility

* Enter inside the "ER_IF" directory: `cd /app/erif/ER_IF`
** Stop ERIF Legacy: `./jbctl -c stop -e it -s settings_solaris.sh` 
** Start ERIF Legacy: `./jbctl -c start -e it -s settings_solaris.sh`

NOTE: Nodes are oss250-oss251-oss252-oss253-oss254-oss255

=== Restart kplexgw 

.If you are not already, log in with the jboss utility

* Enter inside the "kplexgw" directory: `cd /app/jboss/wildfly-18.0.1.Final_Kplex/bin`
** Stop kplexgw: `./kplexgw.sh stop`

IMPORTANT: The stopping process typically lasts between 5 to 15 minutes. To ensure it has stopped, simply rerun the previous command. 

** Start kplexgw: `./kplexgw.sh start` 

NOTE: Nodes are oss259-oss260. Restart one at a time 

== TiT Activities and Updates

.Mail Object: telcoItaly - TiTCare - Request - Aggiornamento Report TIT

```
Request's description:

Good morning,
At the customer's request, to make a new report visible, we kindly ask you to perform the following update on the production database:

use IM_1_HintIntranet
update [RES-02L-] set rpt_profili= '111, 144, TLCC, 997, 172' where I_ID = 67823719

Thank you.

```
* Log inside the required server or servers from EAG, usually indicated in the mail
* Open Microsoft SQL Server Management Studio
* You will be asked to log in as a user, in this case use 'sa' and insert the password
* Open the Databases folder, and once inside do right click inside the `IM_1_HintIntranet` database, select new query
* Once it opens the SQLQuery, paste the script given, select all, and press Execute.

<<<

== Doorway Updates 

.Mail Object: telcoItaly Applicazione Doorway - change

```
Request's description:
Impacted URLs:
doorway.telcoItaly.co.uk

Impacted services:
telcoItaly Doorway

Machines impacted:
osx262v

Request Description:
== STEP #1 - Back-up filesystem.
Make backups

== STEP #2 - Downloading updates.
Download the attached package tda-registry_update.zipper

== STEP #3 - Update filesystem for change VF root implementation.
Copy the contents of the tda-registry_update.zip per package (where directories and files are already properly organized) to the /app/telcoItaly/tda-registry folder where the application is installed

== STEP #4 - Clearing Cache.
Empty the contents of the folder to follow by running the command:
rm -rf /app/telcoItaly/tda-registry/var/cache/twig/*

== STEP #5 - Vendor-side testing.
Notify successful execution of STEP #3 and wait for confirmation from the vendor before concluding the change
```
.Backup
* From EAG open Egde Browser, using the https://10.128.123.9/[vmware vCenter]
* In the search bar type `osx262v`
* Once the info is displayed, go to actions, take snapshots and make a snapshot of the machine

IMPORTANT: if there are older snapshots regarding this activity delete them

* Control that the process is completed

.Update
* Log inside the required server `osx262v`
* As `root` copy the files in the correspondent folder
** Example: 
```
cp -o /home/ansysad/tda-registry_update/lib/User/UserController.php /app/telcoItaly/tda-registry/lib/User/
cp -o /home/ansysad/tda-registry_update/scripts/DeactivateUsers.php /app/telcoItaly/tda-registry/scripts/
```

* Clear the cache with the command indicated 
* Answer the mail saying that the activity is completed

{author} {email} & {author_2} {email_2}
